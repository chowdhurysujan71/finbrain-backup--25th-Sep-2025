{
  "metadata": {
    "generated_at": "2025-09-15T11:25:00Z", 
    "purpose": "Definitive system freeze map to prevent crashes during legacy code quarantine",
    "version": "3.0",
    "method": "Programmatic enumeration of all Blueprint definitions, registrations, and dependencies",
    "compliance": "Uses exact categories: Auth, PWA, Expense Contract, Messenger, Admin, Legacy"
  },
  "critical_import_patterns": [
    {
      "pattern": "from db_base import db",
      "count": 85,
      "risk_level": "CRITICAL",
      "description": "Canonical database import pattern used throughout production codebase",
      "files_sample": [
        "app.py", "models.py", "models_pca.py", "pwa_ui.py", 
        "utils/production_router.py", "handlers/expense.py", 
        "routes/pca_api.py", "routes/pca_ui.py", "routes/audit_api.py", 
        "routes/ops_quickscan.py", "backend_assistant.py"
      ],
      "impact": "Breaking db_base.py will crash entire system (85+ files)",
      "mitigation": "NEVER quarantine db_base.py or any files it depends on"
    },
    {
      "pattern": "from app import limiter", 
      "count": 1,
      "risk_level": "HIGH",
      "description": "PWA auth blueprint depends on app.py limiter global",
      "files": ["pwa_ui.py"],
      "impact": "Auth system crashes if app structure changes",
      "mitigation": "Consider moving limiter to dedicated module or blueprint-local config"
    },
    {
      "pattern": "sys.path.insert(0, '_quarantine')",
      "count": 1,
      "risk_level": "CRITICAL",
      "description": "Production router imports from quarantined code via sys.path manipulation",
      "files": ["utils/production_router.py"],
      "impact": "Order-dependent quarantine import breaks core routing",
      "mitigation": "Extract contains_money functions to production_router.py, remove sys.path hack"
    }
  ],
  "blueprints_production": [
    {
      "name": "pwa_ui",
      "definition": "pwa_ui = Blueprint('pwa_ui', __name__)",
      "file": "pwa_ui.py:14",
      "url_prefix": null,
      "registration": "app.py:2189",
      "usage": "Auth, PWA",
      "route_count": 13,
      "critical": true
    },
    {
      "name": "backend_api", 
      "definition": "backend_api = Blueprint('backend_api', __name__, url_prefix='/api/backend')",
      "file": "routes_backend_assistant.py:32",
      "url_prefix": "/api/backend",
      "registration": "app.py:2198",
      "usage": "Expense Contract",
      "route_count": 8,
      "critical": true
    },
    {
      "name": "pca_api",
      "definition": "pca_api = Blueprint('pca_api', __name__, url_prefix='/api')",
      "file": "routes/pca_api.py:28", 
      "url_prefix": "/api",
      "registration": "app.py:262",
      "usage": "Admin",
      "route_count": 7,
      "critical": false
    },
    {
      "name": "pca_ui",
      "definition": "pca_ui = Blueprint('pca_ui', __name__)",
      "file": "routes/pca_ui.py:20",
      "url_prefix": null,
      "registration": "app.py:265",
      "usage": "Admin", 
      "route_count": 3,
      "critical": false
    },
    {
      "name": "audit_api",
      "definition": "audit_api = Blueprint('audit_api', __name__, url_prefix='/api/audit')",
      "file": "routes/audit_api.py:21",
      "url_prefix": "/api/audit",
      "registration": "app.py:276",
      "usage": "Admin",
      "route_count": 3,
      "critical": false
    },
    {
      "name": "assets_bp",
      "definition": "assets_bp = Blueprint('assets', __name__, url_prefix='/assets')",
      "file": "routes_assets.py:22",
      "url_prefix": "/assets", 
      "registration": "app.py:287",
      "usage": "Admin",
      "route_count": 3,
      "critical": false
    },
    {
      "name": "redis_smoke_bp",
      "definition": "redis_smoke_bp = Blueprint('redis_smoke', __name__)",
      "file": "app/routes_redis_smoke.py:9",
      "url_prefix": null,
      "registration": "app.py:299",
      "usage": "Admin",
      "route_count": 1,
      "critical": false
    },
    {
      "name": "admin_ops",
      "definition": "admin_ops = Blueprint('admin_ops', __name__)",
      "file": "admin_ops.py:14",
      "url_prefix": null,
      "registration": "app.py:1899", 
      "usage": "Admin",
      "route_count": 4,
      "critical": false
    },
    {
      "name": "coaching_bp",
      "definition": "coaching_bp = Blueprint('coaching', __name__, url_prefix='/ops/coaching')",
      "file": "app_coaching_endpoints.py:12",
      "url_prefix": "/ops/coaching",
      "registration": "app.py:1904",
      "usage": "Admin",
      "route_count": 11,
      "critical": false
    },
    {
      "name": "quickscan (registered as quickscan_bp)",
      "definition": "bp = Blueprint('quickscan', __name__)",
      "file": "routes/ops_quickscan.py:9",
      "url_prefix": null,
      "registration": "app.py:2026",
      "usage": "Admin",
      "route_count": 1,
      "critical": false
    }
  ],
  "blueprints_nonproduction": [
    {
      "name": "telemetry_bp",
      "definition": "telemetry_bp = Blueprint('telemetry', __name__)",
      "file": "routes_telemetry.py:12",
      "registration": "routes_telemetry.py:292 (self-registration)",
      "usage": "Admin",
      "status": "conditional_registration"
    },
    {
      "name": "replay_bp", 
      "definition": "replay_bp = Blueprint('replay', __name__, url_prefix='/api/replay')",
      "file": "phase3_replay_debug.py:23",
      "registration": "phase3_replay_debug.py (debug only)",
      "usage": "Legacy",
      "status": "debug_only"
    },
    {
      "name": "production_bp",
      "definition": "production_bp = Blueprint('production', __name__, url_prefix='/api/production')",
      "file": "phase5_production_blast.py:22",
      "registration": "phase5_production_blast.py (test only)",
      "usage": "Legacy",
      "status": "test_only"
    },
    {
      "name": "monitoring_bp",
      "definition": "monitoring_bp = Blueprint('monitoring', __name__, url_prefix='/api/monitoring')",
      "file": "phase4_enhanced_monitoring.py:22", 
      "registration": "phase4_enhanced_monitoring.py (test only)",
      "usage": "Legacy",
      "status": "test_only"
    }
  ],
  "routes_by_usage": {
    "Auth": [
      {"path": "/login", "file": "pwa_ui.py", "line": 156, "method": "GET"},
      {"path": "/register", "file": "pwa_ui.py", "line": 163, "method": "GET"},
      {"path": "/auth/login", "file": "pwa_ui.py", "line": 170, "method": "POST"},
      {"path": "/auth/register", "file": "pwa_ui.py", "line": 248, "method": "POST"},
      {"path": "/auth/logout", "file": "pwa_ui.py", "line": 369, "method": "POST"}
    ],
    "PWA": [
      {"path": "/chat", "file": "pwa_ui.py", "line": 112, "method": "GET"}, 
      {"path": "/report", "file": "pwa_ui.py", "line": 123, "method": "GET"},
      {"path": "/profile", "file": "pwa_ui.py", "line": 134, "method": "GET"},
      {"path": "/challenge", "file": "pwa_ui.py", "line": 145, "method": "GET"},
      {"path": "/offline", "file": "pwa_ui.py", "line": 383, "method": "GET"},
      {"path": "/partials/entries", "file": "pwa_ui.py", "line": 392, "method": "GET"},
      {"path": "/ai-chat-test", "file": "pwa_ui.py", "line": 451, "method": "POST"},
      {"path": "/ai-chat", "file": "pwa_ui.py", "line": 490, "method": "POST"},
      {"path": "/sw.js", "file": "pwa_ui.py", "line": 659, "method": "GET"},
      {"path": "/manifest.webmanifest", "file": "pwa_ui.py", "line": 670, "method": "GET"}
    ],
    "Expense Contract": [
      {"path": "/expense", "file": "pwa_ui.py", "line": 507, "method": "POST"},
      {"path": "/api/backend/propose_expense", "file": "routes_backend_assistant.py", "line": 77, "method": "POST"},
      {"path": "/api/backend/add_expense", "file": "routes_backend_assistant.py", "line": 135, "method": "POST"},
      {"path": "/api/backend/delete_expense", "file": "routes_backend_assistant.py", "line": 277, "method": "POST"},
      {"path": "/api/backend/get_totals", "file": "routes_backend_assistant.py", "line": 341, "method": "POST"},
      {"path": "/api/backend/get_recent_expenses", "file": "routes_backend_assistant.py", "line": 392, "method": "POST"},
      {"path": "/api/backend/process_message", "file": "routes_backend_assistant.py", "line": 505, "method": "POST"},
      {"path": "/api/backend/user_summary", "file": "routes_backend_assistant.py", "line": 564, "method": "POST"},
      {"path": "/api/backend/user_expenses", "file": "routes_backend_assistant.py", "line": 616, "method": "POST"},
      {"path": "/user/<psid_hash>/insights", "file": "app.py", "line": 1255, "method": "GET"},
      {"path": "/user/<psid_hash>/category/<category_name>", "file": "app.py", "line": 1370, "method": "GET"},
      {"path": "/user/<psid_hash>/categories", "file": "app.py", "line": 1406, "method": "GET"},
      {"path": "/api/preview/report", "file": "app.py", "line": 1700, "method": "GET"}
    ],
    "Messenger": [
      {"path": "/webhook/messenger", "file": "app.py", "line": 1014, "method": "GET,POST"}
    ],
    "Admin": [
      {"path": "/admin", "file": "app.py", "line": 489, "method": "GET"},
      {"path": "/diagnostics", "file": "app.py", "line": 867, "method": "GET"},
      {"path": "/__test_error", "file": "app.py", "line": 907, "method": "GET"},
      {"path": "/health/deployment", "file": "app.py", "line": 912, "method": "GET"},
      {"path": "/diagnose/router", "file": "app.py", "line": 1083, "method": "GET"},
      {"path": "/ops", "file": "app.py", "line": 1144, "method": "GET"},
      {"path": "/ops/token-refresh-status", "file": "app.py", "line": 1233, "method": "GET"},
      {"path": "/ops/pca/status", "file": "app.py", "line": 1453, "method": "GET"},
      {"path": "/ops/pca/health", "file": "app.py", "line": 1479, "method": "GET"},
      {"path": "/ops/pca/overlay", "file": "app.py", "line": 1500, "method": "GET"},
      {"path": "/ops/pca/telemetry", "file": "app.py", "line": 1519, "method": "GET"},
      {"path": "/ops/pca/canary", "file": "app.py", "line": 1540, "method": "GET,POST"},
      {"path": "/psid/<psid_hash>", "file": "app.py", "line": 1590, "method": "GET"},
      {"path": "/version", "file": "app.py", "line": 1664, "method": "GET"},
      {"path": "/ops/telemetry", "file": "app.py", "line": 1735, "method": "GET"},
      {"path": "/ops/ai/ping", "file": "app.py", "line": 1779, "method": "GET"},
      {"path": "/ops/rl/reset", "file": "app.py", "line": 1818, "method": "POST"},
      {"path": "/ops/trace", "file": "app.py", "line": 1841, "method": "GET"},
      {"path": "/ops/users", "file": "app.py", "line": 1865, "method": "GET"},
      {"path": "/jobs", "file": "app.py", "line": 2043, "method": "POST"},
      {"path": "/jobs/<job_id>/status", "file": "app.py", "line": 2109, "method": "GET"},
      {"path": "/jobs/<job_id>/cancel", "file": "app.py", "line": 2128, "method": "POST"},
      {"path": "/jobs/status", "file": "app.py", "line": 2147, "method": "GET"},
      {"path": "/api/backend/uat_checklist", "file": "routes_backend_assistant.py", "line": 443, "method": "GET"},
      {"path": "/api/backend/schemas", "file": "routes_backend_assistant.py", "line": 474, "method": "GET"},
      {"path": "/api/backend/health", "file": "routes_backend_assistant.py", "line": 669, "method": "GET"},
      {"path": "/api/pca/rules", "file": "routes/pca_ui.py", "line": 22, "method": "GET"},
      {"path": "/api/pca/transactions/<tx_id>/audit", "file": "routes/pca_ui.py", "line": 61, "method": "GET"},
      {"path": "/api/pca/dashboard/pca", "file": "routes/pca_ui.py", "line": 97, "method": "GET"},
      {"path": "/api/pca/rules/create", "file": "routes/pca_api.py", "line": 45, "method": "POST"},
      {"path": "/api/pca/rules/<rule_id>/toggle", "file": "routes/pca_api.py", "line": 146, "method": "POST"},
      {"path": "/api/pca/rules/<rule_id>/preview", "file": "routes/pca_api.py", "line": 223, "method": "GET"},
      {"path": "/api/pca/rules", "file": "routes/pca_api.py", "line": 258, "method": "GET"},
      {"path": "/api/pca/rules/<rule_id>", "file": "routes/pca_api.py", "line": 291, "method": "DELETE"},
      {"path": "/api/pca/corrections/create", "file": "routes/pca_api.py", "line": 320, "method": "POST"},
      {"path": "/api/pca/transactions/<tx_id>/effective", "file": "routes/pca_api.py", "line": 369, "method": "GET"},
      {"path": "/ops/quickscan", "file": "routes/ops_quickscan.py", "line": 11, "method": "GET"},
      {"path": "/api/audit/transactions/<tx_id>", "file": "routes/audit_api.py", "line": 55, "method": "GET"},
      {"path": "/api/audit/transactions/<tx_id>/compare", "file": "routes/audit_api.py", "line": 166, "method": "GET"},
      {"path": "/api/audit/health", "file": "routes/audit_api.py", "line": 238, "method": "GET"},
      {"path": "/metrics", "file": "routes_telemetry.py", "line": 14, "method": "GET"},
      {"path": "/admin/metrics", "file": "routes_telemetry.py", "line": 36, "method": "GET"}
    ],
    "Core": [
      {"path": "/", "file": "app.py", "line": 411, "method": "GET"},
      {"path": "/health", "file": "app.py", "line": 700, "method": "GET"},
      {"path": "/readyz", "file": "app.py", "line": 716, "method": "GET"}
    ]
  },
  "models_by_usage": {
    "Auth": [
      {"class": "User", "file": "models.py", "line": 85, "table": "users"}
    ],
    "Expense Contract": [
      {"class": "Expense", "file": "models.py", "line": 12, "table": "expenses"},
      {"class": "ExpenseEdit", "file": "models.py", "line": 51, "table": "expense_edits"},
      {"class": "MonthlySummary", "file": "models.py", "line": 181, "table": "monthly_summaries"}
    ],
    "Admin": [
      {"class": "RateLimit", "file": "models.py", "line": 198, "table": "rate_limits"},
      {"class": "UserMilestone", "file": "models.py", "line": 215, "table": "user_milestones"},
      {"class": "ReportFeedback", "file": "models.py", "line": 233, "table": "report_feedback"},
      {"class": "TelemetryEvent", "file": "models.py", "line": 252, "table": "telemetry_events"},
      {"class": "GrowthCounter", "file": "models.py", "line": 266, "table": "growth_counters"},
      {"class": "TransactionEffective", "file": "models_pca.py", "line": 12, "table": "transactions_effective"},
      {"class": "UserCorrection", "file": "models_pca.py", "line": 54, "table": "user_corrections"},
      {"class": "UserRule", "file": "models_pca.py", "line": 86, "table": "user_rules"},
      {"class": "InferenceSnapshot", "file": "models_pca.py", "line": 123, "table": "inference_snapshots"}
    ],
    "Core": [
      {"class": "Base", "file": "db_base.py", "line": 4, "table": null}
    ]
  },
  "never_quarantine_files": [
    {
      "file": "app.py",
      "reason": "Main Flask application with blueprint registrations and core routes",
      "impact": "System startup failure"
    },
    {
      "file": "db_base.py",
      "reason": "Canonical database configuration imported by 85+ files",
      "impact": "Database access failure across entire system"
    },
    {
      "file": "models.py",
      "reason": "Core data models for Auth and Expense Contract",
      "impact": "Database schema failure"
    },
    {
      "file": "models_pca.py", 
      "reason": "PCA data models used by Admin functionality",
      "impact": "Admin features failure"
    },
    {
      "file": "pwa_ui.py",
      "reason": "Critical PWA and Auth routes",
      "impact": "User interface and authentication failure"
    },
    {
      "file": "routes_backend_assistant.py",
      "reason": "Core Expense Contract API endpoints",
      "impact": "Expense tracking functionality failure"
    },
    {
      "file": "utils/production_router.py",
      "reason": "Core message routing logic",
      "impact": "Message processing failure"
    },
    {
      "file": "main.py",
      "reason": "Application entry point",
      "impact": "Application startup failure"
    }
  ],
  "quarantine_safe_files": [
    "_quarantine/finbrain_router_deprecated.py",
    "_quarantine/archive_legacy/*",
    "phase3_replay_debug.py",
    "phase4_enhanced_monitoring.py", 
    "phase5_production_blast.py",
    "tests/*",
    "scripts/*"
  ],
  "actionable_fixes": [
    {
      "risk": "sys.path.insert(0, '_quarantine') in utils/production_router.py",
      "action": "Extract contains_money and contains_money_with_correction_fallback functions from quarantined code into utils/production_router.py",
      "steps": [
        "Copy functions from _quarantine/finbrain_router_deprecated.py to utils/production_router.py",
        "Remove sys.path.insert(0, '_quarantine') line",
        "Remove import from finbrain_router_deprecated", 
        "Test that routing still works correctly"
      ],
      "verification": "grep -r 'sys.path.insert.*quarantine' should return no results in production code"
    },
    {
      "risk": "PWA auth depends on app.limiter global",
      "action": "Move limiter to dedicated module or make blueprint-local",
      "steps": [
        "Create utils/rate_limiting.py with limiter configuration",
        "Import limiter from utils/rate_limiting in pwa_ui.py",
        "Update app.py to use same limiter source",
        "Test that rate limiting still works"
      ],
      "verification": "Search for 'from app import limiter' should return no results"
    }
  ],
  "verification_checklist": [
    "✓ All Blueprint definitions programmatically enumerated with exact names",
    "✓ Production vs non-production blueprint registrations separated",
    "✓ Routes classified using exact categories (Auth, PWA, Expense Contract, Messenger, Admin, Core)",
    "✓ Models classified by usage areas",
    "✓ Critical import patterns identified with impact analysis",
    "✓ Never-quarantine files listed with rationale",
    "✓ Actionable fixes provided with verification steps",
    "✓ sys.path mutations flagged as critical risks"
  ],
  "validation_commands": [
    "grep -r 'from db_base import db' --include='*.py' | wc -l  # Should be ~85",
    "grep -r 'sys.path.insert.*quarantine' --include='*.py' utils/  # Should be 1 result", 
    "grep -r 'Blueprint(' --include='*.py' | grep -v test | wc -l  # Should match blueprint count",
    "grep -r 'app.register_blueprint' app.py | wc -l  # Should be 10 registrations"
  ],
  "usage_summary": {
    "Auth": {"routes": 5, "models": 1, "blueprints": 1, "critical": true},
    "PWA": {"routes": 10, "models": 0, "blueprints": 1, "critical": true},
    "Expense Contract": {"routes": 13, "models": 3, "blueprints": 1, "critical": true},
    "Messenger": {"routes": 1, "models": 0, "blueprints": 0, "critical": true},
    "Admin": {"routes": 37, "models": 9, "blueprints": 7, "critical": false},
    "Core": {"routes": 3, "models": 1, "blueprints": 0, "critical": true}
  }
}