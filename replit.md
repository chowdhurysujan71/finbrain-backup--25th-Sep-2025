# FinBrain

## Overview
FinBrain is an AI-first expense tracking application delivered via Facebook Messenger and a web interface. It processes expense messages, provides intelligent AI categorization, and offers streamlined financial insights. The system prioritizes security, featuring mandatory HTTPS and signature verification. Its core purpose is to simplify expense tracking and provide AI-powered financial analysis.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### Web Framework
FinBrain utilizes Flask with SQLAlchemy for database integration. It features a secure webhook at `/webhook/messenger` requiring signature verification and HTTPS. Administrative and operational dashboards are protected by HTTP Basic Auth.

### Database Design
The primary database is PostgreSQL, with `expenses` for detailed logs, `users` for profiles and rate limiting, and `monthly_summaries` for aggregated analytics. SQLAlchemy ORM manages models with connection pooling.

### Security Architecture
Security measures include X-Hub-Signature-256 verification for Facebook webhooks, HTTPS enforcement, and automated monitoring of Facebook Page Access Tokens. User identifiers (Facebook PSIDs) are SHA-256 hashed, and all sensitive credentials are environment variables. The system adheres to messaging policies and implements per-user rate limiting.

### Cold-Start Mitigation System
AI providers are pre-warmed on app boot, and a 5-minute health ping system maintains server activity. The `/health` endpoint monitors uptime, queue depth, and AI status.

### Background Processing System
A thread pool handles background message processing to ensure non-blocking webhook responses, including a 5-second timeout with fallback replies. An intelligent AI recommendation layer (Gemini-2.5-flash-lite) categorizes expenses and provides tips. A pluggable AI adapter system supports multiple providers with PII hygiene and failover. A robust AI rate limiting system prevents abuse.

### Message Processing Pipeline
Inbound messages are acknowledged immediately and queued for background processing. The system features an engagement-driven AI architecture with proactive onboarding and personalized interactions. New users receive a welcome sequence with income assessment, spending category identification, and focus area selection using AI-powered input parsing (Gemini-2.5-flash).

The AI expense parser handles complex multi-item messages (e.g., "coffee 100, burger 300 and watermelon juice 300") using regex and AI fallback to extract multiple expenses, improving context awareness.

The context-driven system builds user-specific data packets from 30-day spending patterns, enforcing structured responses via JSON schema validation. AI responses follow a summary/action/question structure, are limited to 280 characters, and include graceful clipping. A per-user AI rate limiter (4 requests/60s) prevents spam. Habit-forming UX elements trigger weekly challenges and check-ins.

### AI-Enhanced Web Dashboard
Each user has a personalized AI insights dashboard accessible via `/user/{psid_hash}/insights`, providing real-time financial analysis, recommendations, and spending pattern insights generated by Gemini AI. The dashboard includes AI-generated financial summaries, smart tips, category-specific insights, and recent conversation history. Admin users can access a user management interface with links to user insights.

### Facebook Messenger Integration
The system integrates with the Facebook Messenger Platform via Graph API v17.0, using `facebook_handler.py` for platform-specific interactions and unified expense processing.

### Modular Architecture
The codebase is modular, organized into a `utils` package containing modules for expense parsing, categorization, security, database operations, rate limiting, Facebook messaging, webhook processing, background execution, AI adaptation, cold-start mitigation, health pings, routing, policy guarding, report generation, and scheduling.

### AI Constitution Implementation Status
The system provides sophisticated AI-driven financial advice and learning capabilities. Key implemented AI capabilities include context awareness, multi-step reasoning, recommendation intelligence, self-learning, long-term intelligence, meta-intelligence, and safeguards.

## External Dependencies

### Messaging Platform
- **Facebook Graph API v17.0**: For Messenger platform integration and PSID handling.

### Database
- **PostgreSQL**: Primary data storage.
- **SQLAlchemy**: ORM for database interactions.

### Security & Validation
- **hashlib**: For SHA-256 hashing of user identifiers.
- **regex (re)**: For amount extraction and message parsing.

### Web Framework
- **Flask**: Core web server.
- **Gunicorn**: WSGI server for production.
- **ProxyFix**: For handling reverse proxy headers.

### Frontend
- **Bootstrap 5**: CSS framework for the dashboard UI.
- **Font Awesome 6**: Icon library for the dashboard UI.

## Recent Improvements (August 18, 2025)

### Intent Routing Fix
Fixed critical "log-ack" loop where all messages received generic responses. Implemented priority-based intent routing:

- **Intent Priority**: SUMMARY → INSIGHT → UNDO → LOG_EXPENSE → UNKNOWN (commands checked before expense logging)
- **Deterministic Handlers**: Created `handlers/` module with database-driven summary, rule-based insights, and multi-expense logging
- **Multi-Expense Parser**: Enhanced parser extracts multiple amounts with context-aware category detection ("100 on Uber and 500 on shoes")
- **Rate Limit Bypass**: Summary/Insight/Undo commands bypass AI rate limiting entirely for instant responses

### Multi-Expense Logging Complete Fix
Fixed critical function signature and import errors preventing multi-expense logging. System now properly:

- **Hash Consistency**: Resolved `resolve_user_id()` function signature mismatches and import errors across codebase
- **Database Integration**: Fixed `ensure_hashed` import issues in `utils/db.py` and `utils/production_router.py`
- **Multi-Expense Processing**: Successfully logs multiple expenses from single messages ("lunch 125 and parking 55")
- **Detailed Responses**: Generates AI-powered responses with expense breakdowns instead of generic fallbacks
- **Intent Resolution**: Properly returns `ai_expense_logged` intent with accurate total amounts

### Single-Source-of-Truth Identity System - COMPLETED (August 18, 2025)
**CRITICAL MILESTONE**: Implemented bulletproof single-source-of-truth identity system eliminating identity fragmentation:

- **Mandatory ID_SALT**: System crashes if ID_SALT environment variable missing, preventing worker salt inconsistencies
- **Canonical PSID Extraction**: `psid_from_event()` only extracts sender.id from message/postback events, ignores delivery/read completely
- **Webhook Intake Hash**: Identity computed once at webhook intake using canonical extraction, never recomputed in workers
- **Debug Echo Enabled**: All responses include 24h debug: "pong | psid_hash={hash8}... | mode={AI|STD|FBK|ERR}"
- **Background Processing**: Updated background processor to use canonical identity system throughout
- **Zero Fragmentation**: Complete prevention of multiple hashes per user, single source of truth maintained
- **Production Verified**: All tests pass, LSP diagnostics clean, canonical identity system fully operational