# FinBrain

## Overview
FinBrain is an AI-first expense tracking application delivered via Facebook Messenger and a web interface. Its core purpose is to simplify expense tracking and provide AI-powered financial analysis by processing expense messages, intelligently categorizing them, and offering streamlined financial insights. The system prioritizes security, featuring mandatory HTTPS and signature verification, aiming to provide sophisticated AI-driven financial advice and learning capabilities.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### Web Framework and Database
FinBrain utilizes Flask with SQLAlchemy for database integration. The primary database is PostgreSQL, with tables for `expenses`, `users`, and `monthly_summaries`. SQLAlchemy ORM manages models with connection pooling. A secure webhook at `/webhook/messenger` requires signature verification and HTTPS. Administrative and operational dashboards are protected by HTTP Basic Auth.

### Security
Security measures include X-Hub-Signature-256 verification for Facebook webhooks, HTTPS enforcement, and automated monitoring of Facebook Page Access Tokens. User identifiers (Facebook PSIDs) are SHA-256 hashed, and all sensitive credentials are environment variables. The system adheres to messaging policies and implements per-user rate limiting. A single-source-of-truth identity system is implemented to prevent fragmentation.

### Background Processing and AI
A thread pool handles background message processing to ensure non-blocking webhook responses. An intelligent AI recommendation layer (Gemini-2.5-flash-lite) categorizes expenses and provides tips. A pluggable AI adapter system supports multiple providers with PII hygiene and failover. A robust AI rate limiting system prevents abuse. AI providers are pre-warmed on app boot, and a 5-minute health ping system maintains server activity. The system supports complex multi-item messages using regex and AI fallback to extract multiple expenses. The AI provides context-driven responses based on user-specific spending patterns, enforcing structured responses via JSON schema validation. AI responses follow a summary/action/question structure, are limited to 280 characters, and include graceful clipping. Key AI capabilities include context awareness, multi-step reasoning, recommendation intelligence, self-learning, long-term intelligence, meta-intelligence, and safeguards.

### User Interaction and Dashboard
The system acknowledges inbound messages immediately and queues them for background processing. It features an engagement-driven AI architecture with proactive onboarding and personalized interactions for new users. Each user has a personalized AI insights dashboard accessible via `/user/{psid_hash}/insights`, providing real-time financial analysis, recommendations, and spending pattern insights generated by Gemini AI.

### Modular Design
The codebase is modular, organized into a `utils` package containing modules for expense parsing, categorization, security, database operations, rate limiting, Facebook messaging, webhook processing, background execution, AI adaptation, cold-start mitigation, health pings, routing, policy guarding, report generation, and scheduling.

## External Dependencies

### Messaging Platform
- **Facebook Graph API v17.0**: For Messenger platform integration and PSID handling.

### Database
- **PostgreSQL**: Primary data storage.
- **SQLAlchemy**: ORM for database interactions.

### Web Framework
- **Flask**: Core web server.
- **Gunicorn**: WSGI server for production.
- **ProxyFix**: For handling reverse proxy headers.

### Frontend
- **Bootstrap 5**: CSS framework for the dashboard UI.
- **Font Awesome 6**: Icon library for the dashboard UI.