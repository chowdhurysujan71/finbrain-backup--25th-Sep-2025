{
  "metadata": {
    "generated_at": "2025-09-15T11:07:00Z",
    "purpose": "Comprehensive system freeze map to prevent crashes during legacy code quarantine",
    "version": "2.0",
    "fixes": "Added canonical db_base imports, limiter imports, all blueprint definitions, sys.path mutations, proper usage classification with exact categories"
  },
  "critical_import_patterns": [
    {
      "pattern": "from db_base import db",
      "count": 85,
      "files_sample": [
        "app.py",
        "models.py",
        "models_pca.py",
        "pwa_ui.py",
        "utils/production_router.py",
        "handlers/expense.py",
        "routes/pca_api.py",
        "routes/pca_ui.py",
        "routes/audit_api.py",
        "routes/ops_quickscan.py"
      ],
      "status": "used:core",
      "critical": true,
      "risk": "CRITICAL - Canonical database import pattern, breaking db_base.py will crash 85+ files"
    },
    {
      "pattern": "from app import limiter",
      "count": 1,
      "files": ["pwa_ui.py"],
      "status": "used:Auth",
      "critical": true,
      "risk": "HIGH - PWA auth depends on app.py limiter global, breaking app structure crashes auth"
    },
    {
      "pattern": "sys.path.insert(0, '_quarantine')",
      "count": 1,
      "files": ["utils/production_router.py"],
      "status": "quarantine_dependency",
      "critical": true,
      "risk": "CRITICAL - Order-dependent import from quarantine, hidden dependency that will break if quarantine is moved"
    }
  ],
  "blueprints": [
    {
      "name": "pwa_ui",
      "file": "pwa_ui.py",
      "url_prefix": null,
      "registered_in": "app.py:2189",
      "status": "used:PWA_Auth",
      "routes_count": 13
    },
    {
      "name": "backend_api",
      "file": "routes_backend_assistant.py",
      "url_prefix": "/api/backend",
      "registered_in": "app.py:2198",
      "status": "used:Expense_Contract",
      "routes_count": 8
    },
    {
      "name": "pca_api",
      "file": "routes/pca_api.py",
      "url_prefix": "/api",
      "registered_in": "app.py:262",
      "status": "used:Admin",
      "routes_count": 7
    },
    {
      "name": "pca_ui",
      "file": "routes/pca_ui.py",
      "url_prefix": null,
      "registered_in": "app.py:265",
      "status": "used:Admin",
      "routes_count": 3
    },
    {
      "name": "audit_api",
      "file": "routes/audit_api.py",
      "url_prefix": "/api/audit",
      "registered_in": "app.py:276",
      "status": "used:Admin",
      "routes_count": 3
    },
    {
      "name": "assets_bp",
      "file": "routes_assets.py",
      "url_prefix": "/assets",
      "registered_in": "app.py:287",
      "status": "used:Admin",
      "routes_count": 3
    },
    {
      "name": "admin_ops",
      "file": "admin_ops.py",
      "url_prefix": null,
      "registered_in": "app.py:1899",
      "status": "used:Admin",
      "routes_count": 4
    },
    {
      "name": "coaching_bp",
      "file": "app_coaching_endpoints.py",
      "url_prefix": "/ops/coaching",
      "registered_in": "app.py:1904",
      "status": "used:Admin",
      "routes_count": 11
    },
    {
      "name": "quickscan_bp",
      "file": "routes/ops_quickscan.py",
      "url_prefix": null,
      "registered_in": "app.py:2026",
      "status": "used:Admin",
      "routes_count": 1
    },
    {
      "name": "telemetry_bp",
      "file": "routes_telemetry.py",
      "url_prefix": null,
      "registered_in": "routes_telemetry.py:292",
      "status": "used:Admin",
      "routes_count": 2
    }
  ],
  "routes_by_usage": {
    "Auth": [
      {"path": "/login", "file": "pwa_ui.py", "line": 156, "method": "GET"},
      {"path": "/register", "file": "pwa_ui.py", "line": 163, "method": "GET"},
      {"path": "/auth/login", "file": "pwa_ui.py", "line": 170, "method": "POST"},
      {"path": "/auth/register", "file": "pwa_ui.py", "line": 248, "method": "POST"},
      {"path": "/auth/logout", "file": "pwa_ui.py", "line": 369, "method": "POST"}
    ],
    "PWA": [
      {"path": "/chat", "file": "pwa_ui.py", "line": 112, "method": "GET"},
      {"path": "/report", "file": "pwa_ui.py", "line": 123, "method": "GET"},
      {"path": "/profile", "file": "pwa_ui.py", "line": 134, "method": "GET"},
      {"path": "/challenge", "file": "pwa_ui.py", "line": 145, "method": "GET"},
      {"path": "/offline", "file": "pwa_ui.py", "line": 383, "method": "GET"},
      {"path": "/partials/entries", "file": "pwa_ui.py", "line": 392, "method": "GET"},
      {"path": "/ai-chat-test", "file": "pwa_ui.py", "line": 451, "method": "POST"},
      {"path": "/ai-chat", "file": "pwa_ui.py", "line": 490, "method": "POST"},
      {"path": "/sw.js", "file": "pwa_ui.py", "line": 659, "method": "GET"},
      {"path": "/manifest.webmanifest", "file": "pwa_ui.py", "line": 670, "method": "GET"}
    ],
    "Expense_Contract": [
      {"path": "/expense", "file": "pwa_ui.py", "line": 507, "method": "POST"},
      {"path": "/api/backend/propose_expense", "file": "routes_backend_assistant.py", "line": 77, "method": "POST"},
      {"path": "/api/backend/add_expense", "file": "routes_backend_assistant.py", "line": 135, "method": "POST"},
      {"path": "/api/backend/delete_expense", "file": "routes_backend_assistant.py", "line": 277, "method": "POST"},
      {"path": "/api/backend/get_totals", "file": "routes_backend_assistant.py", "line": 341, "method": "POST"},
      {"path": "/api/backend/get_recent_expenses", "file": "routes_backend_assistant.py", "line": 392, "method": "POST"},
      {"path": "/api/backend/process_message", "file": "routes_backend_assistant.py", "line": 505, "method": "POST"},
      {"path": "/api/backend/user_summary", "file": "routes_backend_assistant.py", "line": 564, "method": "POST"},
      {"path": "/api/backend/user_expenses", "file": "routes_backend_assistant.py", "line": 616, "method": "POST"},
      {"path": "/user/<psid_hash>/insights", "file": "app.py", "line": 1255, "method": "GET"},
      {"path": "/user/<psid_hash>/category/<category_name>", "file": "app.py", "line": 1370, "method": "GET"},
      {"path": "/user/<psid_hash>/categories", "file": "app.py", "line": 1406, "method": "GET"},
      {"path": "/api/preview/report", "file": "app.py", "line": 1700, "method": "GET"}
    ],
    "Messenger": [
      {"path": "/webhook/messenger", "file": "app.py", "line": 1014, "method": "GET,POST"}
    ],
    "Admin": [
      {"path": "/admin", "file": "app.py", "line": 489, "method": "GET"},
      {"path": "/diagnostics", "file": "app.py", "line": 867, "method": "GET"},
      {"path": "/__test_error", "file": "app.py", "line": 907, "method": "GET"},
      {"path": "/health/deployment", "file": "app.py", "line": 912, "method": "GET"},
      {"path": "/diagnose/router", "file": "app.py", "line": 1083, "method": "GET"},
      {"path": "/ops", "file": "app.py", "line": 1144, "method": "GET"},
      {"path": "/ops/token-refresh-status", "file": "app.py", "line": 1233, "method": "GET"},
      {"path": "/ops/pca/status", "file": "app.py", "line": 1453, "method": "GET"},
      {"path": "/ops/pca/health", "file": "app.py", "line": 1479, "method": "GET"},
      {"path": "/ops/pca/overlay", "file": "app.py", "line": 1500, "method": "GET"},
      {"path": "/ops/pca/telemetry", "file": "app.py", "line": 1519, "method": "GET"},
      {"path": "/ops/pca/canary", "file": "app.py", "line": 1540, "method": "GET,POST"},
      {"path": "/psid/<psid_hash>", "file": "app.py", "line": 1590, "method": "GET"},
      {"path": "/version", "file": "app.py", "line": 1664, "method": "GET"},
      {"path": "/ops/telemetry", "file": "app.py", "line": 1735, "method": "GET"},
      {"path": "/ops/ai/ping", "file": "app.py", "line": 1779, "method": "GET"},
      {"path": "/ops/rl/reset", "file": "app.py", "line": 1818, "method": "POST"},
      {"path": "/ops/trace", "file": "app.py", "line": 1841, "method": "GET"},
      {"path": "/ops/users", "file": "app.py", "line": 1865, "method": "GET"},
      {"path": "/jobs", "file": "app.py", "line": 2043, "method": "POST"},
      {"path": "/jobs/<job_id>/status", "file": "app.py", "line": 2109, "method": "GET"},
      {"path": "/jobs/<job_id>/cancel", "file": "app.py", "line": 2128, "method": "POST"},
      {"path": "/jobs/status", "file": "app.py", "line": 2147, "method": "GET"},
      {"path": "/api/backend/uat_checklist", "file": "routes_backend_assistant.py", "line": 443, "method": "GET"},
      {"path": "/api/backend/schemas", "file": "routes_backend_assistant.py", "line": 474, "method": "GET"},
      {"path": "/api/backend/health", "file": "routes_backend_assistant.py", "line": 669, "method": "GET"},
      {"path": "/api/pca/rules", "file": "routes/pca_ui.py", "line": 22, "method": "GET"},
      {"path": "/api/pca/transactions/<tx_id>/audit", "file": "routes/pca_ui.py", "line": 61, "method": "GET"},
      {"path": "/api/pca/dashboard/pca", "file": "routes/pca_ui.py", "line": 97, "method": "GET"},
      {"path": "/api/pca/rules/create", "file": "routes/pca_api.py", "line": 45, "method": "POST"},
      {"path": "/api/pca/rules/<rule_id>/toggle", "file": "routes/pca_api.py", "line": 146, "method": "POST"},
      {"path": "/api/pca/rules/<rule_id>/preview", "file": "routes/pca_api.py", "line": 223, "method": "GET"},
      {"path": "/api/pca/rules", "file": "routes/pca_api.py", "line": 258, "method": "GET"},
      {"path": "/api/pca/rules/<rule_id>", "file": "routes/pca_api.py", "line": 291, "method": "DELETE"},
      {"path": "/api/pca/corrections/create", "file": "routes/pca_api.py", "line": 320, "method": "POST"},
      {"path": "/api/pca/transactions/<tx_id>/effective", "file": "routes/pca_api.py", "line": 369, "method": "GET"},
      {"path": "/ops/quickscan", "file": "routes/ops_quickscan.py", "line": 11, "method": "GET"},
      {"path": "/api/audit/transactions/<tx_id>", "file": "routes/audit_api.py", "line": 55, "method": "GET"},
      {"path": "/api/audit/transactions/<tx_id>/compare", "file": "routes/audit_api.py", "line": 166, "method": "GET"},
      {"path": "/api/audit/health", "file": "routes/audit_api.py", "line": 238, "method": "GET"},
      {"path": "/metrics", "file": "routes_telemetry.py", "line": 14, "method": "GET"},
      {"path": "/admin/metrics", "file": "routes_telemetry.py", "line": 36, "method": "GET"}
    ],
    "Core": [
      {"path": "/", "file": "app.py", "line": 411, "method": "GET"},
      {"path": "/health", "file": "app.py", "line": 700, "method": "GET"},
      {"path": "/readyz", "file": "app.py", "line": 716, "method": "GET"}
    ]
  },
  "models_by_usage": {
    "Auth": [
      {"class": "User", "file": "models.py", "line": 85, "table": "users"}
    ],
    "Expense_Contract": [
      {"class": "Expense", "file": "models.py", "line": 12, "table": "expenses"},
      {"class": "ExpenseEdit", "file": "models.py", "line": 51, "table": "expense_edits"},
      {"class": "MonthlySummary", "file": "models.py", "line": 181, "table": "monthly_summaries"}
    ],
    "Admin": [
      {"class": "RateLimit", "file": "models.py", "line": 198, "table": "rate_limits"},
      {"class": "UserMilestone", "file": "models.py", "line": 215, "table": "user_milestones"},
      {"class": "ReportFeedback", "file": "models.py", "line": 233, "table": "report_feedback"},
      {"class": "TelemetryEvent", "file": "models.py", "line": 252, "table": "telemetry_events"},
      {"class": "GrowthCounter", "file": "models.py", "line": 266, "table": "growth_counters"},
      {"class": "TransactionEffective", "file": "models_pca.py", "line": 12, "table": "transactions_effective"},
      {"class": "UserCorrection", "file": "models_pca.py", "line": 54, "table": "user_corrections"},
      {"class": "UserRule", "file": "models_pca.py", "line": 86, "table": "user_rules"},
      {"class": "InferenceSnapshot", "file": "models_pca.py", "line": 123, "table": "inference_snapshots"}
    ],
    "Core": [
      {"class": "Base", "file": "db_base.py", "line": 4, "table": null}
    ]
  },
  "critical_quarantine_risks": [
    {
      "risk": "Production router depends on quarantined finbrain_router_deprecated.py via sys.path manipulation",
      "affected_files": ["utils/production_router.py"],
      "impact": "CRITICAL - Core routing functionality could fail",
      "fix_required": "Extract contains_money and contains_money_with_correction_fallback functions to utils/production_router.py",
      "detection": "Search for sys.path.insert(0, '_quarantine') in production code"
    },
    {
      "risk": "PWA auth blueprint depends on app.limiter global import",
      "affected_files": ["pwa_ui.py"],
      "impact": "HIGH - Authentication system will crash if app structure changes",
      "fix_required": "Consider moving limiter to dedicated module or blueprint-local config",
      "detection": "Search for 'from app import limiter'"
    },
    {
      "risk": "85+ files use canonical db_base.db import",
      "affected_files": ["All active production files"],
      "impact": "CRITICAL - Entire system crashes if db_base.py is quarantined",
      "fix_required": "Never quarantine db_base.py or models.py/models_pca.py",
      "detection": "Search for 'from db_base import db'"
    }
  ],
  "quarantine_safe_files": [
    "_quarantine/finbrain_router_deprecated.py",
    "_quarantine/archive_legacy/*"
  ],
  "never_quarantine_files": [
    "app.py",
    "db_base.py", 
    "models.py",
    "models_pca.py",
    "pwa_ui.py",
    "routes_backend_assistant.py",
    "utils/production_router.py",
    "main.py"
  ],
  "usage_summary": {
    "Auth": {
      "routes": 5,
      "models": 1,
      "blueprints": 1,
      "critical_files": ["pwa_ui.py", "models.py"]
    },
    "PWA": {
      "routes": 10,
      "models": 0,
      "blueprints": 1,
      "critical_files": ["pwa_ui.py"]
    },
    "Expense_Contract": {
      "routes": 13,
      "models": 3,
      "blueprints": 1,
      "critical_files": ["routes_backend_assistant.py", "models.py", "app.py"]
    },
    "Messenger": {
      "routes": 1,
      "models": 0,
      "blueprints": 0,
      "critical_files": ["app.py"]
    },
    "Admin": {
      "routes": 37,
      "models": 9,
      "blueprints": 7,
      "critical_files": ["app.py", "routes/pca_api.py", "routes/pca_ui.py", "routes/audit_api.py", "routes/ops_quickscan.py", "routes_telemetry.py", "admin_ops.py", "models.py", "models_pca.py"]
    },
    "Core": {
      "routes": 3,
      "models": 1,
      "blueprints": 0,
      "critical_files": ["app.py", "db_base.py"]
    }
  },
  "verification_checklist": [
    "✓ Canonical db_base import pattern captured (85+ files)",
    "✓ PWA limiter dependency identified (pwa_ui.py)",  
    "✓ sys.path quarantine mutation found (utils/production_router.py)",
    "✓ All blueprint definitions and registrations mapped",
    "✓ Routes classified by exact usage areas (Auth/PWA/Expense Contract/Messenger/Admin/Core)",
    "✓ Models classified by usage areas",
    "✓ Critical quarantine risks identified with specific fixes",
    "✓ Never-quarantine files list provided",
    "✓ Verification patterns for safe quarantine operations"
  ]
}