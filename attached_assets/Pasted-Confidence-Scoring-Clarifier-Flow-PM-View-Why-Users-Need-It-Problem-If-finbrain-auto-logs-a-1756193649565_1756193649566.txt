Confidence Scoring & Clarifier Flow
ğŸ¯ PM View â€” Why Users Need It

Problem: If finbrain auto-logs an expense into the wrong category without asking, trust collapses. Users feel the system is â€œmessing with their money.â€

Solution: Instead of silently guessing, finbrain should act like a cautious assistant: â€œI think this is X, but let me check.â€

User Promise: â€œfinbrain will never mislabel your expense behind your back. It will either log confidently, ask you, or fall back to safe raw logging.â€

Example:

User: â€œbkash 500â€
finbrain: â€œNot sure. Was this Utilities, Fees, or Other?â€

This keeps the user in control while still giving them value even when the AI isnâ€™t 100% sure.

ğŸ›  CTO View â€” How We Implement Safely

No changes to raw ledger: All expenses are always logged in transactions_raw â€” append-only, immutable.

Additive decision logic only:

If confidence â‰¥ Ï„_high (0.85) â†’ AUTO_APPLY (system applies the category directly).

If Ï„_low (0.55 â‰¤ confidence < 0.85) â†’ ASK_ONCE (present clarifier chips: 3 likely categories + â€œOtherâ€).

If confidence < Ï„_low â†’ RAW_ONLY (log raw, leave category blank, ask later).

Structured Canonical Command (CC):

Decision and clarifier metadata are written into inference_snapshot.

UI reads the CC â†’ either auto-confirms, shows chips, or shows a â€œsaved rawâ€ message.

Flags ensure safety:

Default PCA_MODE=FALLBACK means none of this logic runs until explicitly enabled.

Clarifier UI only appears if ENABLE_CLARIFIERS=true.

ğŸ§© Data Flow (Safe by Design)

User logs: â€œStarbux 780.â€

Agent computes intent=LOG_EXPENSE, category=coffee, confidence=0.91.

â‰¥0.85 â†’ AUTO_APPLY â†’ logs category Coffee.

User logs: â€œbkash 500.â€

Confidence=0.62 â†’ ASK_ONCE.

System logs raw expense (500) and surfaces clarifier chips.

User picks â€œUtilities.â€ Effective overlay updated, raw stays intact.

User logs: â€œMart payment 1200.â€

Confidence=0.32 â†’ RAW_ONLY.

Logs raw entry with no category.

Shows: â€œSaved à§³1200; category to confirm later.â€

âš ï¸ Risk Controls

Core ledger untouched: Every expense still logs into transactions_raw.

Overlay-only updates: Corrections and clarifier selections update user_corrections / transactions_effective.

Safe defaults: If thresholds misbehave, fallback is RAW_ONLY â†’ never wrong category silently.

Instant rollback: One flag flip â†’ PCA_MODE=FALLBACK â†’ legacy logging resumes, clarifiers disappear.

ğŸš€ Why This is MVP-Critical

Protects against the #1 user trust risk: silent miscategorisation.

Gives users a voice in ambiguous cases while keeping the system helpful.

Provides a clear audit trail: â€œHereâ€™s what we thought, hereâ€™s what you chose.â€