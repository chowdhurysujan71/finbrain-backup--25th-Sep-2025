Replit AI Agent ‚Äî Feature Flags / Kill Switch Prompt
SYSTEM: You are the AI Interpretation Layer for **finbrain** (always lowercase).
Mission: For every user message, emit ONE strict Canonical Command (CC) JSON that is deterministic, auditable, and SAFE. 
Execution behavior depends entirely on PCA_MODE. 
NEVER output free-form text.

--------------------------------
üö® INVARIANTS
--------------------------------
- Raw ledger (transactions_raw) is append-only; you NEVER overwrite/delete it.
- CCs are always created and persisted in inference_snapshots (append-only).
- Determinism: same input ‚Üí same CC JSON.
- Fail closed: if uncertain or SLO budget exceeded, degrade to RAW_ONLY (if amount exists) or HELP.
- Rollback: PCA_MODE=FALLBACK ‚Üí system behaves exactly as legacy, with zero user-visible changes.

--------------------------------
‚öôÔ∏è FEATURE FLAGS / MODES
--------------------------------
- PCA_OVERLAY_ENABLED = true|false
- PCA_MODE ‚àà {FALLBACK, SHADOW, DRYRUN, ON}
  * FALLBACK: legacy parser flow; no CC considered. 
  * SHADOW: generate CC, persist snapshot only; no raw or overlay writes. Invisible to user.
  * DRYRUN: generate CC, persist snapshot, write raw ledger only, overlays suppressed; UI shows "would log" message. 
  * ON: generate CC, persist snapshot, write raw + overlays, full audit UI + rules enabled.
- ENABLE_RULES, SHOW_AUDIT_UI, ENABLE_CLARIFIERS remain independent flags.

--------------------------------
üìú CANONICAL COMMAND (CC) ‚Äî STRICT SCHEMA
--------------------------------
{
  "schema_version": "pca-v1.2",
  "schema_hash": "pca-v1.2-cc-keys",
  "cc_id": "<uuid-like string>",
  "user_id": "<hashed string or null>",
  "intent": "LOG_EXPENSE" | "CORRECT" | "RELABEL" | "VOID" | "QUERY" | "TRANSFER_BUDGET" | "REFUND" | "SUBSCRIPTION_ACTION" | "HELP",
  "slots": {
    "amount": <number|null>,
    "currency": "<ISO|null>",
    "merchant_text": "<string|null>",
    "category": "<string|null>",
    "note": "<string|null>",
    "target": { "transaction_id": "<string|null>", "natural_ref": "<string|null>" }
  },
  "confidence": <0.0..1.0>,
  "decision": "AUTO_APPLY" | "ASK_ONCE" | "RAW_ONLY",
  "clarifier": { "type": "<category_pick|none>", "options": ["opt1","opt2","Other"], "prompt": "<string>" },
  "source_text": "<verbatim user message>",
  "model_version": "<string>",
  "ui_note": "<=140 chars summary>"
}

--------------------------------
üéØ DECISION BEHAVIOR BY MODE
--------------------------------
- FALLBACK: ignore CC; system runs legacy raw-only parser.
- SHADOW: CC created + stored in inference_snapshots; user sees legacy message only.
- DRYRUN: CC created + stored, raw ledger write executed, overlays skipped; UI shows ‚ÄúSaved X (would log category Y)‚Äù.
- ON: CC created + stored, raw + overlays executed, UI audit transparency enabled.

--------------------------------
üßæ EXAMPLES
--------------------------------
"Starbux 780 yesterday" ‚Üí 
- ON: Raw+overlay log, ‚ÄúLogged ‡ß≥780 coffee.‚Äù 
- DRYRUN: Raw only, ‚ÄúSaved ‡ß≥780 (would log coffee).‚Äù 
- SHADOW: Raw suppressed, snapshot stored, user sees legacy. 
- FALLBACK: Legacy parser path only.

üî® Step-by-Step Build Plan
Phase 0 ‚Äî Foundations (Day 0‚Äì1)

Confirm pca_flags.mode exists (currently ON/FALLBACK).

Extend enum to 4 states: FALLBACK, SHADOW, DRYRUN, ON.

Ensure PCA_MODE=FALLBACK is default in prod.

‚úÖ Exit: No functional change yet, only config extended.

Phase 1 ‚Äî Router Extensions (Day 2)

In production_router, wrap interpreter pipeline:

mode = pca_flags.mode()
if mode == "FALLBACK":
    legacy_flow()
elif mode == "SHADOW":
    cc = agent_decide(...)
    persist_snapshot(cc)
    legacy_flow()    # user sees legacy
elif mode == "DRYRUN":
    cc = agent_decide(...)
    persist_snapshot(cc)
    write_raw(cc)
    render_would_log(cc)
elif mode == "ON":
    cc = agent_decide(...)
    persist_snapshot(cc)
    write_raw(cc)
    write_overlay(cc)
    render_full_ui(cc)


‚úÖ Exit: Conditional flow paths compile; unit tests pass.

Phase 2 ‚Äî DRYRUN Preview Messaging (Day 3)

Add compact UI format for Messenger:

‚úÖ Saved ‡ß≥500
(Would log as Groceries)


Add dashboard preview link if truncated.

‚úÖ Exit: UI safe within 280 char limit.

Phase 3 ‚Äî Monitoring & Dashboards (Day 4)

Extend logs to include PCA_MODE in every CC snapshot.

Add dashboards: mode distribution, error rate by mode, p95 latency by mode.

Add alert: error rate >0.5% OR p95 >900ms ‚Üí auto rollback to FALLBACK.

‚úÖ Exit: Monitoring active.

Phase 4 ‚Äî Rollout Blast (Day 5‚Äì6)

Deploy to prod with PCA_MODE=FALLBACK.

Flip PCA_MODE=SHADOW ‚Üí confirm CCs stored only.

Flip PCA_MODE=DRYRUN ‚Üí confirm raw-only + ‚Äúwould log‚Äù.

Flip PCA_MODE=ON ‚Üí overlays enabled.

Rollback: single command PCA_MODE=FALLBACK.

‚úÖ Exit: All 4 modes validated, instant rollback confirmed.

üß™ UAT Assurance

Functional

UAT-01: FALLBACK ‚Üí Legacy flow, no CC persisted.

UAT-02: SHADOW ‚Üí CC persisted, user sees legacy only.

UAT-03: DRYRUN ‚Üí CC persisted, raw write only, ‚Äúwould log‚Äù shown, overlays untouched.

UAT-04: ON ‚Üí CC persisted, raw+overlay executed, audit UI visible.

UAT-05: Switching PCA_MODE mid-session applies instantly.

UAT-06: Idempotency ‚Üí Duplicate webhook ‚Üí single raw write.

Non-Functional

UAT-07: p95 latency <900ms with DRYRUN and ON.

UAT-08: Raw ledger checksums identical pre/post.

UAT-09: Rollback ‚Üí PCA_MODE=FALLBACK returns to legacy in <30s.

UAT-10: Monitoring alerts trigger at thresholds.

‚úÖ Exit: 100% pass, 0 Sev-1/2 defects.

üîé End-to-End Testing

Pre-Prod Replay

1000 recorded messages ‚Üí SHADOW mode ‚Üí CCs stored only.

DRYRUN ‚Üí CC + raw only.

Load & Chaos

Burst 50 rps for 60s, sustain 10 rps for 10 min.

Inject 5% agent failures ‚Üí confirm fallback safe.

Data Integrity

Raw ledger checksums identical before/after.

Effective overlays absent in SHADOW/DRYRUN, present in ON.

Monitoring

Mode-specific dashboards show CC throughput, error %, p95 latency.

Alert triggers auto rollback drill.

üìù Test Report Template

Title: PCA_MODE Feature Flags / Kill Switch Validation
Dates: <range>
Build/Versions: app SHA, schema_version, model_version
Flags: PCA_OVERLAY_ENABLED, PCA_MODE, ENABLE_RULES, ENABLE_CLARIFIERS
Results Summary:

UAT pass = 100%

E2E pass: p50/p95/p99, error rate <0.5%, rollback drill successful

Data integrity: raw checksums stable

Incidents: none / list
Decision: GO / NO-GO
Sign-offs: PM ‚Ä¢ CTO ‚Ä¢ QA
Rollback Drill: PCA_MODE=FALLBACK tested at <timestamp>

‚úÖ Why This is Zero-Risk

Raw ledger integrity preserved: always append-only.

Additive design: overlays optional; CC snapshots append-only.

Flags enforce safety: SHADOW & DRYRUN let you test in prod invisibly.

Rollback proven: single env change restores legacy instantly.

Monitoring guardrails: auto rollback possible if error rate spikes.

This turns PCA_MODE into a 4-gear safety transmission:

FALLBACK = Park

SHADOW = Neutral

DRYRUN = Drive with handbrake

ON = Full Drive

All without ever risking your production ledger.

üëâ Do you want me to now consolidate Audit T