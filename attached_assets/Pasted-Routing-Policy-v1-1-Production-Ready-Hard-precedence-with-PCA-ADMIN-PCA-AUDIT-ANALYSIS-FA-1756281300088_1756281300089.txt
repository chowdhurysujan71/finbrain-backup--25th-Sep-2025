Routing Policy v1.1 (Production-Ready)
Hard precedence (with PCA)

ADMIN → PCA_AUDIT → ANALYSIS → FAQ → COACHING → SMALLTALK

PCA_AUDIT: when audit/recording mode is on, ANALYSIS must respect audit flows (no bypass).

Deterministic rules (state-aware)

Evaluate top→bottom; first match wins.

ADMIN: text starts with /id|/debug|/help

PCA_AUDIT: PCA_AUDIT_MODE=true (env/overlay) → route to audit handler

ANALYSIS:

has_time_window (today/this week/this month/date) OR has_analysis_terms (analysis/report/summary/“বিশ্লেষণ/রিপোর্ট”)

OR explicit analysis while in coaching: in_coaching_session AND explicit_analysis_request

Output: safe-minimal if ledger_totals==0

FAQ: “what can you do / privacy / pricing / features” (EN/BN)

COACHING:

(has_coaching_verbs AND ledger_count_30d ≥ COACHING_TXN_THRESHOLD)

AND not an explicit analysis request

OR in_coaching_session AND NOT explicit_analysis_request (session continuity)

SMALLTALK: default

Explicit analysis request examples: “analysis please”, “what did I spend…”, “spending summary”, “বিশ্লেষণ দাও”, “এই মাসের খরচ”

Config flags (overlays)
ROUTER_MODE=hybrid                  # ai_first | hybrid | rules_first
ROUTER_SCOPE=zero_ledger_only       # zero_ledger_only | analysis_keywords_only | all
ROUTER_RULES_VERSION=2025-08-27
PCA_AUDIT_MODE=false
COACHING_TXN_THRESHOLD=10           # ← configurable
COACHING_SESSION_RESPECT=true
BILINGUAL_ROUTING=true
UNIQUENESS_MODE=data_version        # vs timestamp

Bilingual keyword sets (seed)

Time window (EN): today|this (week|month)|last (week|month)|yesterday|\b\d{4}-\d{2}-\d{2}\b

Time window (BN): আজ|এই (সপ্তাহ|মাস)|গত (সপ্তাহ|মাস)|গতকাল|\b\d{4}-\d{2}-\d{2}\b

Analysis terms (EN): analysis|spending (summary|report)|what did I spend

Analysis terms (BN): বিশ্লেষণ|খরচের (সারাংশ|রিপোর্ট)|আমি কত খরচ করেছি

Coaching verbs (EN): save|reduce|cut|budget|plan

Coaching verbs (BN): সেভ|কমানো|কাট|বাজেট|পরিকল্পনা

Uniqueness (truthful + helpful)

If data_version unchanged and bullet hash unchanged → reply:

EN: No changes since your last check. Add a new expense to refresh your analysis.

BN: শেষবারের পর থেকে নতুন পরিবর্তন নেই। নতুন খরচ যোগ করলে বিশ্লেষণ আপডেট হবে।

Add micro-insight (deterministic):
Tip: your top category this month is {TopCat} (~{Share}%). Want ideas to trim it?

Rollout (one-button deploy friendly)
Phase 1 (today, ultra-safe)

ROUTER_MODE=hybrid

ROUTER_SCOPE=zero_ledger_only

COACHING_TXN_THRESHOLD=10

UNIQUENESS_MODE=data_version

Keep coaching session continuity, but explicit analysis overrides coaching (your concern addressed).

Phase 2 (after 24–48h clean metrics)

ROUTER_SCOPE=analysis_keywords_only

Then ROUTER_SCOPE=all if stable.

Instant rollback (no redeploy)

ROUTER_MODE=ai_first (retains safe-minimal & contamination safeguards)

Tests & gates
Contract tests (EN+BN; sample)

ANALYSIS: “analysis please”, “what did I spend this week?”, “এই মাসের খরচ বিশ্লেষণ”

FAQ: “what can you do”, “privacy”, “মূল্য কত”

COACHING: “help me reduce food spend”, “খাবারের খরচ কমাতে চাই”

ADMIN: “/id”, “/help”

SMALLTALK: “hi”, “ধন্যবাদ”

CI must pass all; add 20–30 phrases now, grow weekly.

Monitoring

routing.intent_distribution{intent=*}

routing.misroute_corrections_total

insights.repeat_suppressed_total (should correlate with unchanged data_version)

Existing safety: insights.tenant_mismatch_total==0, schema/non-JSON within thresholds

Product sign-offs needed

Final precedence including PCA_AUDIT (above)

Bangla keyword list

Unchanged-data copy (EN/BN)

COACHING_TXN_THRESHOLD default (start at 10; adjust by overlay)

7-day playbook (concise)

Day 0: Deploy Phase 1; monitor; run contract tests live

Day 1–2: Review routing logs & user replies; tweak keywords (overlay-only)

Day 3: Flip to analysis_keywords_only; watch misroutes

Day 4–5: Add top 5 ambiguous phrases to contract tests

Day 6: Prep Phase 2 → ROUTER_SCOPE=all if metrics good

Day 7: Exec review; decide to move ROUTER_MODE=rules_first or keep hybrid