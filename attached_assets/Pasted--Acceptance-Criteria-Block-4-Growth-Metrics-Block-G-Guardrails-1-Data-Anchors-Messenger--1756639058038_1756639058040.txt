ðŸ“‹ Acceptance Criteria â€” Block 4 (Growth Metrics) + Block G (Guardrails)
1. Data Anchors (Messenger Demo Mode)

First interaction timestamp (when user first messages FinBrain) is treated as created_at (proxy for signup).

Signup source is set to "messenger_demo" for all users by default.

This timestamp is never overwritten.

2. Block 4 â€” Analytics Metrics
D1 Logged

When a user logs their first expense on the same local calendar day as their first interaction:

d1_logged flips to true (one-time only).

Emit telemetry:

{ "event": "activation_d1", "user_id": "<hash>" }


If the first log happens on a later day â†’ no flip, no event.

Idempotency: repeated logs on Day 1 do not re-flip or re-emit.

D3 Completed

When a user logs â‰¥3 expenses within 72h (259,200s) of first interaction:

d3_completed flips to true (one-time only).

Emit telemetry:

{ "event": "activation_d3", "user_id": "<hash>" }


If the 3rd log is after 72h â†’ no flip, no event.

Idempotency: never re-flips after set.

Reports Requested

Every time a REPORT is generated:

reports_requested increments by 1.

Emit telemetry (optional):

{ "event": "report_requested", "user_id": "<hash>" }


Counter increments correctly across multiple sessions.

3. Block G â€” Guardrails Between Analytics & Milestones
Separation of Purposes

Block 4 fields (d1_logged, d3_completed, reports_requested) are analytics-only.

Milestones (streak-3, 10-logs) are user-visible nudges only.

Analytics flags never trigger milestone messages.

Streak Independence

Streaks are computed only from consecutive local calendar days with â‰¥1 log/day.

streak-3 fires only when crossing from 2 â†’ 3 consecutive days.

D1/D3 flags never affect streak calculation.

Daily Cap (Milestones Only)

At most 1 milestone message per local calendar day per user.

If streak-3 and 10-logs both cross in the same day:

Only the first milestone is shown.

Both analytics flips (D1/D3) can still happen if eligible.

Telemetry Namespacing

Analytics events: activation_d1, activation_d3, report_requested.

Milestone events: milestone_fired with type in {"streak-3","10-logs"}.

No overlap or reuse of event names.

Feature Flags

FEATURE_ANALYTICS_BLOCK4 â†’ controls D1/D3/Reports.

FEATURE_MILESTONES_SIMPLE â†’ controls streak-3, 10-logs nudges.

Must be independently toggleable.

Disabling milestones does not disable analytics.

4. Timezone Handling

All day-based calculations use Asia/Dhaka local calendar days.

Edge case check:

Signup at 23:50, first log at 00:05 â†’ not D1.

Logs across midnight are correctly bucketed into new days.

5. Idempotency & Concurrency

D1 and D3 flips happen once per user lifetime.

Milestones fire once per user lifetime.

Daily cap ensures no >1 milestone message per day.

Concurrent logs (e.g., multiple quick submissions) never create duplicate flips/events.

6. Non-Regressions

Expense logging latency not noticeably affected by analytics checks.

REPORT generation still works normally; only adds counter increment.

Milestone system continues to function independently if analytics flags are disabled.

âœ… Final Success Criteria

When running through QA tests:

Analytics funnel works: you can measure % of users activating Day 1, % completing D3, avg REPORTs requested per user.

Gamification works: streak-3 and 10-logs fire correctly, but never more than once/day and never confused with analytics flags.

Data you present to leadership is clean: telemetry for analytics vs milestones is fully separated.

User trust is intact: nudges are consistent with real behavior (no false streaks, no spam).