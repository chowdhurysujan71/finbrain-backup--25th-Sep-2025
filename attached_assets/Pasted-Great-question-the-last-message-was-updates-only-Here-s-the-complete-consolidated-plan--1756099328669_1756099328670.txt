Great question â€” the last message was **updates only**. Hereâ€™s the **complete, consolidated plan** (everything in one place) so you can hand it to the Replit agent without hunting through earlier threads.

---

# FinBrain Guardrails v2 â€” Full Implementation Package (Post-FAQ, Low Risk)

## Objectives

* Add spam/cost guardrails **without** touching DB schema or breaking FAQ speed.
* Keep all changes **additive**, **flag-gated**, and **reversible**.
* Owner bypass for **30522114904098519** / **a20425ef9abcb34401cd0f33773b7f5071bc2713885cf7f15b026e6fe26916ff**.

## Injection Point (critical)

* Run **FAQ first** (instant, deterministic).
* If **no FAQ match**, run guardrails.
* Then continue to **Limiter â†’ RL-2 (if limited) â†’ AI (if enabled) â†’ Dispatcher/Handlers**.

---

## Files to Add / Edit

* **NEW** `utils/ux_copy.py` â€” all UX strings in one place.
* **NEW** `utils/ttl_store.py` â€” Redis (preferred) or safe in-proc TTL store (with Redis import fallback).
* **EDIT** `utils/ai_adapter_v2.py` â€” prepend Messaging Guardrail prompt.
* **EDIT** `utils/production_router.py` â€” post-FAQ guardrail middleware (burst, daily cap, PII, anti-repeat; all flag-gated).
* **NEW** `tests/test_guardrails.py` â€” smoke tests for store + copy.

---

## Environment (minimal, safe defaults)

```
FEATURE_BURST_LIMIT=false
FEATURE_DAILY_CAP=false
FEATURE_PII_FILTER=false
FEATURE_ANTI_REPEAT=false
OWNER_PSID=30522114904098519
OWNER_PSID_HASH=a20425ef9abcb34401cd0f33773b7f5071bc2713885cf7f15b026e6fe26916ff
DAILY_CAP_LIMIT=30
BURST_LIMIT_MAX=5
BURST_LIMIT_WINDOW_SECONDS=10
REDIS_URL=  # optional; use Redis if available
```

---

## UX Copy (paste into `utils/ux_copy.py`)

* **Burst:** â€œâš ï¸ Youâ€™re sending messages very fastâ€”please slow down.â€
* **Daily cap:** â€œâ³ Youâ€™ve reached todayâ€™s limit of 30 messages. Please come back tomorrow.â€
* **Repeat:** â€œGot thatâ€”anything new youâ€™d like me to do now: log, summary, or insight?â€
* **PII:** â€œğŸ”’ For your security, please donâ€™t share sensitive information here.â€
* **Busy:** â€œâ³ FinBrain is a bit busy right now. Please try again in a few minutes.â€
* **Fallback:** â€œğŸ§­ I can help you log expenses, show summaries, or share insights. Try: â€˜coffee 120â€™ or â€˜summary this weekâ€™. For details visit [www.finbrain.appâ€](http://www.finbrain.appâ€)

---

## Messaging Guardrail Prompt (prepend in `utils/ai_adapter_v2.py`)

* Natural, concise, one bubble, â‰¤280 chars, 0â€“2 emojis, one CTA.
* Acknowledge â†’ answer/log/insight â†’ one next step.
* Avoid repeating exact phrasing within \~45s; ask **one** clarifying question if unclear.
* Never request/echo card numbers, passwords, or PII.

*(Use the improved text from my previous message â€” itâ€™s final.)*

---

## TTL Store (safe Redis import) â€” `utils/ttl_store.py`

* Prefers Redis when `REDIS_URL` exists.
* **Try/except** on `import redis`; fallback to in-proc TTL with locks if package missing.
* Simple ops: `incr(key, ttl)`, `get(key)`, `setex(key, ttl, value)`, `exists(key)`.

---

## Guardrail Middleware (post-FAQ) â€” `utils/production_router.py`

**Order inside handler:**

1. `det = match_faq_or_smalltalk(user_text)` â†’ if present, **return** (no guardrails).
2. `gate = _guardrail_after_faq(psid, psid_hash, text)` â†’ if message returned, **return** it.
3. Proceed to your existing flow (Limiter â†’ RL-2 â†’ AI â†’ Dispatcher/Handlers).

**Guardrails (all flag-gated; owner bypass):**

* **Owner bypass:** skip all checks if PSID or hash matches owner.
* **Burst limiter:** `BURST_LIMIT_MAX` per `BURST_LIMIT_WINDOW_SECONDS` â†’ on exceed, return **SLOW\_DOWN**.
* **Daily cap:** `DAILY_CAP_LIMIT` per UTC day using TTL key `daily:{psid}:{YYYYMMDD}` â†’ on exceed, **DAILY\_LIMIT**. Auto-reset at UTC midnight via TTL.
* **PII light filter:** regex for 13â€“19 digit sequences, `password|pin|otp` â†’ return **PII\_WARNING** (do not echo content).
* **Anti-repeat:** MD5 of full text with **45s** TTL (`repeat:{psid}`) â†’ on identical repeat within window, return **REPEAT\_HINT**. *(MD5 fixes â€œcoffee 120â€ vs â€œcoffee 100â€ collisions).*
* **Graceful failure:** wrap guardrail block in `try/except`; on error, **fail open** (continue normal processing).

---

## UAT (manual, 30â€“40 min)

**Setup**

* Turn flags ON for testing:

  * `FEATURE_BURST_LIMIT=true`
  * `FEATURE_DAILY_CAP=true`
  * `FEATURE_PII_FILTER=true`
  * `FEATURE_ANTI_REPEAT=true`
* Ensure owner ENV is set (PSID + full hash).
* Deploy to your Reserved VM.

**Scenarios**

1. **FAQ preserved**

   * Send `what is finbrain` rapidly 6Ã— â†’ always FAQ response, no SLOW\_DOWN/DAILY\_LIMIT.
2. **Burst limiter (non-FAQ)**

   * 6 non-FAQ messages in 10s â†’ exactly one **SLOW\_DOWN**; after 10s, normal again.
3. **Daily cap**

   * 31 non-FAQ messages same UTC day â†’ 31st gets **DAILY\_LIMIT**; no more messages processed that day.
   * After UTC midnight â†’ counter resets â†’ normal.
4. **PII**

   * Paste a 16-digit number or â€œmy password is 1234â€ â†’ **PII\_WARNING** once; content not echoed.
5. **Anti-repeat (45s)**

   * Send identical text twice within 45s â†’ second gets **REPEAT\_HINT**.
   * â€œcoffee 120â€ then â€œcoffee 100â€ â†’ **no repeat hint**.
6. **Owner bypass**

   * From **30522114904098519** â†’ never see SLOW\_DOWN/DAILY\_LIMIT; all flows normal.
7. **Prompt naturalness**

   * Ask same question twice within 45s â†’ wording varies (not robotic); replies â‰¤280 chars, 0â€“2 emojis, one CTA.

**Latency spot-check**

* FAQ latency unchanged (\~1 ms).
* Non-FAQ overhead target: <10 ms (Redis) / \~1â€“2 ms (in-proc).

---

## End-of-Run Report (fill after UAT)

**Build:** `<commit>`
**Env:** Reserved VM (0.5 vCPU / 2 GiB)
**Date (UTC+6):** `<YYYY-MM-DD>`
**Tester:** `<name>`

### Summary

* âœ… Post-FAQ injection confirmed (FAQ path untouched, \~1 ms).
* âœ… Burst limiter (5/10s), daily cap (30/day, UTC reset), PII, anti-repeat (45s, MD5) working.
* âœ… Owner bypass (PSID + hash) respected.
* âœ… Messaging prompt produces short, friendly, varied replies (â‰¤280 chars, 0â€“2 emojis, one CTA).
* âœ… No regressions in logging/summaries/insights.

### Metrics

* Avg FAQ latency: `<X ms>` (baseline parity)
* Non-FAQ guardrail overhead: `<Y ms>`
* Burst hits/day: `<n>` | Daily caps/day: `<n>` | PII warns/day: `<n>` | Repeat hints/day: `<n>`

### Issues

* `<none / list with severity & repro>`

### Go/No-Go

* **GO / NO-GO** â€” Sign-off: `<name>`

---

## Rollback & Safety

* **Flags OFF** to disable any module instantly.
* Redis import guarded with try/except; falls back to in-proc store.
* Guardrail middleware wrapped in try/except; failures never block user flows.
* All edits are **additive**; no file moves/renames; no DB/schema changes.

---

This is the **entire plan** (not just updates): prompts, guardrail logic, UX copy, injection point, envs, UAT, report, rollback. If you want, I can collapse this into a single â€œReplit Agentâ€ instruction block formatted exactly for your agent UI.
