2025-08-21 15:29:30.66
2b41acac
User
2025-08-21 09:29:30,659 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): graph.facebook.com:443
2025-08-21 15:29:31.15
2b41acac
User
2025-08-21 09:29:31,158 - urllib3.connectionpool - DEBUG - https://graph.facebook.com:443 "GET /v17.0/debug_token?input_token=EAAQIpDHnY54BPM81e5RC6RTqGszDgIWjKKElVhxr6iwqyY5ZBsjBDuuZCP7xf5FFkpwebwkDpKI8aywZBlrOw92q69OTviZB642QoQc3tAm4BKkzwcNHnCgG9ziLai4dii9ZArBFZBmN7DRT8O06RmGQVExRkJyf8jTK6wo3eviYBfcB3aCW72ZCZCrzPJnyP5z6SVS3cN9VxFDjre73VoBnkXcZD&access_token=1135401211749278%7C2a2fb85a0e1aea27c64575b9e2fcf7eb HTTP/1.1" 200 310
2025-08-21 15:29:31.19
2b41acac
User
2025-08-21 09:29:31,196 - urllib3.connectionpool - DEBUG - http://localhost:5000 "GET /health HTTP/1.1" 200 532
2025-08-21 15:29:31.19
2b41acac
User
2025-08-21 09:29:31,197 - utils.health_ping - DEBUG - Health ping successful: 200 in 2429.76ms
2025-08-21 15:29:48.99
2b41acac
User
{"timestamp": "2025-08-21T09:29:48.994499", "event_type": "webhook_processed", "rid": "unknown", "psid_hash": "a20425ef9abcb34401cd0f33773b7f5071bc2713885cf7f15b026e6fe26916ff", "mid": "m__0m86tfGfW9L2IHp97sEPVq3yeIemJTv7lBPtVv3PtSCRR39NLG9tIfDs7f8pm1rdxewtphMRoIyeSRG254xFg", "intent": "queued"}
2025-08-21 15:29:48.99
2b41acac
User
2025-08-21 09:29:48,994 - finbrain.structured - INFO - {"timestamp": "2025-08-21T09:29:48.994499", "event_type": "webhook_processed", "rid": "unknown", "psid_hash": "a20425ef9abcb34401cd0f33773b7f5071bc2713885cf7f15b026e6fe26916ff", "mid": "m__0m86tfGfW9L2IHp97sEPVq3yeIemJTv7lBPtVv3PtSCRR39NLG9tIfDs7f8pm1rdxewtphMRoIyeSRG254xFg", "intent": "queued"}
2025-08-21 15:29:48.99
2b41acac
User
2025-08-21 09:29:48,994 - utils.background_processor - INFO - Request b14126d0: Message queued for background processing
2025-08-21 15:29:48.99
2b41acac
User
{"timestamp": "2025-08-21T09:29:48.995021", "event_type": "webhook_processed", "rid": "unknown", "psid_hash": "a20425ef9abcb34401cd0f33773b7f5071bc2713885cf7f15b026e6fe26916ff", "mid": "m__0m86tfGfW9L2IHp97sEPVq3yeIemJTv7lBPtVv3PtSCRR39NLG9tIfDs7f8pm1rdxewtphMRoIyeSRG254xFg", "intent": "queued"}
2025-08-21 15:29:48.99
2b41acac
User
2025-08-21 09:29:48,995 - finbrain.structured - INFO - {"timestamp": "2025-08-21T09:29:48.995021", "event_type": "webhook_processed", "rid": "unknown", "psid_hash": "a20425ef9abcb34401cd0f33773b7f5071bc2713885cf7f15b026e6fe26916ff", "mid": "m__0m86tfGfW9L2IHp97sEPVq3yeIemJTv7lBPtVv3PtSCRR39NLG9tIfDs7f8pm1rdxewtphMRoIyeSRG254xFg", "intent": "queued"}
2025-08-21 15:29:48.99
2b41acac
User
{"timestamp": "2025-08-21T09:29:48.995176", "event_type": "webhook_processed", "rid": "unknown", "psid_hash": "ee6598ac73f7928e58c86d4321609641a2cda216347e4dc3df5cce0440bc5605", "mid": "1_events", "intent": "success", "processing_ms": 7.23}
2025-08-21 15:29:48.99
2b41acac
User
2025-08-21 09:29:48,995 - finbrain.structured - INFO - {"timestamp": "2025-08-21T09:29:48.995176", "event_type": "webhook_processed", "rid": "unknown", "psid_hash": "ee6598ac73f7928e58c86d4321609641a2cda216347e4dc3df5cce0440bc5605", "mid": "1_events", "intent": "success", "processing_ms": 7.23}
2025-08-21 15:29:48.99
2b41acac
User
2025-08-21 09:29:48,995 - utils.webhook_processor - INFO - Request b14126d0: Webhook processed in 7.23ms, 1 events queued
2025-08-21 15:29:49.28
2b41acac
User
2025-08-21 09:29:49,287 - utils.policy_guard - DEBUG - Updated 24h timestamp for PSID 30522114***
2025-08-21 15:29:49.60
2b41acac
User
2025-08-21 09:29:49,599 - handlers.logger - ERROR - Log handler error: (psycopg2.errors.NotNullViolation) null value in column "month" of relation "expenses" violates not-null constraint
2025-08-21 15:29:49.60
2b41acac
User
DETAIL: Failing row contains (74, a20425ef9abcb34401cd0f33773b7f5071bc2713885cf7f15b026e6fe26916ff, Expense from: coffee 50, 50.00, food, à§³, 2025-08-21, 09:29:49.515808, null, null, 2025-08-21 09:29:49.515811, messenger, coffee 50, ).
2025-08-21 15:29:49.60
2b41acac
User
2025-08-21 15:29:49.60
2b41acac
User
[SQL: INSERT INTO expenses (user_id, description, amount, category, currency, date, time, month, unique_id, created_at, platform, original_message, ai_insights) VALUES (%(user_id)s, %(description)s, %(amount)s, %(category)s, %(currency)s, %(date)s, %(time)s, %(month)s, %(unique_id)s, %(created_at)s, %(platform)s, %(original_message)s, %(ai_insights)s) RETURNING expenses.id]
2025-08-21 15:29:49.60
2b41acac
User
[parameters: {'user_id': 'a20425ef9abcb34401cd0f33773b7f5071bc2713885cf7f15b026e6fe26916ff', 'description': 'Expense from: coffee 50', 'amount': 50.0, 'category': 'food', 'currency': 'à§³', 'date': datetime.date(2025, 8, 21), 'time': datetime.time(9, 29, 49, 515808), 'month': None, 'unique_id': None, 'created_at': datetime.datetime(2025, 8, 21, 9, 29, 49, 515811), 'platform': 'messenger', 'original_message': 'coffee 50', 'ai_insights': ''}]
2025-08-21 15:29:49.60
2b41acac
User
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-08-21 15:29:49.60
2b41acac
User
2025-08-21 09:29:49,600 - finbrain.router - INFO - Production routing: {"rid": "b14126d0", "psid_hash": "a20425ef...", "route": "log", "details": "expense_logged", "timestamp": "2025-08-21T09:29:49.600033+00:00"}
2025-08-21 15:29:49.63
2b41acac
User
2025-08-21 09:29:49,633 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): graph.facebook.com:443
2025-08-21 15:29:51.40
2b41acac
User
2025-08-21 09:29:51,409 - urllib3.connectionpool - DEBUG - https://graph.facebook.com:443 "POST /v19.0/me/messages?access_token=EAAQIpDHnY54BPM81e5RC6RTqGszDgIWjKKElVhxr6iwqyY5ZBsjBDuuZCP7xf5FFkpwebwkDpKI8aywZBlrOw92q69OTviZB642QoQc3tAm4BKkzwcNHnCgG9ziLai4dii9ZArBFZBmN7DRT8O06RmGQVExRkJyf8jTK6wo3eviYBfcB3aCW72ZCZCrzPJnyP5z6SVS3cN9VxFDjre73VoBnkXcZD HTTP/1.1" 200 140
2025-08-21 15:29:51.41
2b41acac
User
{"timestamp": "2025-08-21T09:29:51.410413", "event_type": "graph_api_call", "rid": "unknown", "endpoint": "/v17.0/me/messages", "method": "POST", "status": 200, "duration_ms": 1809.85}
2025-08-21 15:29:51.41
2b41acac
User
2025-08-21 09:29:51,410 - finbrain.structured - INFO - {"timestamp": "2025-08-21T09:29:51.410413", "event_type": "graph_api_call", "rid": "unknown", "endpoint": "/v17.0/me/messages", "method": "POST", "status": 200, "duration_ms": 1809.85}
2025-08-21 15:29:51.41
2b41acac
User
2025-08-21 09:29:51,410 - utils.facebook_handler - INFO - Facebook message sent successfully: m_EB2ZXWb5t6NxYgxeVzajLVq3yeIemJTv7lBPtVv3PtSNvFE6pUqfahNj1AzXxUarhKGl_Kiq7NxSFTfXPwQ-iA
2025-08-21 15:29:51.41
2b41acac
User
2025-08-21 09:29:51,410 - utils.background_processor - INFO - Request b14126d0: Response sent successfully to 3052211490*** (hash: a20425ef...)
2025-08-21 15:29:52.24
2b41acac
User
2025-08-21 09:29:52,249 - utils.webhook_processor - DEBUG - Skipping non-message event (delivery/read/etc)
2025-08-21 15:29:52.24
2b41acac
User
{"timestamp": "2025-08-21T09:29:52.249480", "event_type": "webhook_processed", "rid": "unknown", "psid_hash": "4236a9a6163b269fe4201e7422b9c66951694d94ccbb1ba7b92b7b5094475df8", "mid": "unknown", "intent": "no_events", "processing_ms": 0.18}
2025-08-21 15:29:52.24
2b41acac
User
2025-08-21 09:29:52,249 - finbrain.structured - INFO - {"timestamp": "2025-08-21T09:29:52.249480", "event_type": "webhook_processed", "rid": "unknown", "psid_hash": "4236a9a6163b269fe4201e7422b9c66951694d94ccbb1ba7b92b7b5094475df8", "mid": "unknown", "intent": "no_events", "processing_ms": 0.18}
2025-08-21 15:29:55.82
2b41acac
User
2025-08-21 09:29:55,828 - utils.webhook_processor - DEBUG - Skipping non-message event (delivery/read/etc)
2025-08-21 15:29:55.82
2b41acac
User
{"timestamp": "2025-08-21T09:29:55.828985", "event_type": "webhook_processed", "rid": "unknown", "psid_hash": "4236a9a6163b269fe4201e7422b9c66951694d94ccbb1ba7b92b7b5094475df8", "mid": "unknown", "intent": "no_events", "processing_ms": 0.2}
2025-08-21 15:29:55.82
2b41acac
User
2025-08-21 09:29:55,829 - finbrain.structured - INFO - {"timestamp": "2025-08-21T09:29:55.828985", "event_type": "webhook_processed", "rid": "unknown", "psid_hash": "4236a9a6163b269fe4201e7422b9c66951694d94ccbb1ba7b92b7b5094475df8", "mid": "unknown", "intent": "no_events", "processing_ms": 0.2}

Wrap

Colors
ChatGPT said:

Got it â€” I read through your logs carefully. Hereâ€™s whatâ€™s happening in plain English:

âœ… Whatâ€™s working

Webhook â†’ Queue â†’ Router flow is solid. Your message (coffee 50) got processed, queued, and routed correctly.

AI parse happened (amount = 50, category = food, currency = à§³).

Facebook Send API responded 200 OK â†’ user got a reply.

Performance was excellent: 7.23 ms processing, ~1.8 s to send reply.

ðŸ”´ Whatâ€™s breaking

Database insert failed:

psycopg2.errors.NotNullViolation: null value in column "month"


The expenses table requires a month value, but your insert had "month": None.

That row was rejected, so the expense didnâ€™t persist, even though you saw a reply.

ðŸ“Œ Root cause

Your parser/router is extracting date and time, but not deriving the month field before insert.
DB schema = month NOT NULL.
Current code = month=None â†’ constraint violation.

ðŸŽ¯ What to do

For safe continuity, you need to derive month from date before writing:

expense["month"] = expense["date"].strftime("%Y-%m")


This should happen in your expense logging handler, right before DB insert.

Next steps for testing

Since you want to keep testing as admin without touching code right now:

Treat this as a dry run. Your flow is fine up to DB write, so youâ€™ve verified:

Routing âœ…

AI parse âœ…

Response to Messenger âœ…

Just know expenses wonâ€™t be saved until that month mapping is added.

ðŸ‘‰ Do you want me to write you the exact patch snippet (drop-in safe code) that only adds month mapping so inserts wonâ€™t fail, nothing else touched?