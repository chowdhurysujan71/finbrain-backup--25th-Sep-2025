<!-- Recent Entries Partial for HTMX -->
{% if entries and entries|length > 0 %}
    <div class="entries-list">
        {% for entry in entries[:5] %}
            <div class="entry-item" data-entry-id="{{ entry.id }}">
                <div class="entry-main">
                    <div class="entry-category">
                        {% if entry.category == 'food' %}🍽️
                        {% elif entry.category == 'transport' %}🚗
                        {% elif entry.category == 'shopping' %}🛍️
                        {% elif entry.category == 'bills' %}💡
                        {% elif entry.category == 'entertainment' %}🎬
                        {% elif entry.category == 'health' %}🏥
                        {% elif entry.category == 'education' %}📚
                        {% else %}📝
                        {% endif %}
                        <span class="amount-category">{{ entry.category|title }}</span>
                    </div>
                    
                    <div class="entry-amount">
                        <span class="amount-value">৳{{ "%.2f"|format(entry.amount) }}</span>
                    </div>
                    
                    <button class="entry-action edit" 
                            onclick="editEntry({{ entry.id }})"
                            aria-label="Edit expense">
                        ✏️
                    </button>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <!-- Entries Summary (for last 5 entries shown) -->
    <div class="entries-summary">
        <div class="summary-item">
            <span class="summary-label">Showing:</span>
            <span class="summary-value">Last {{ [entries|length, 5]|min }} expenses</span>
        </div>
    </div>
    
{% else %}
    <!-- Empty State -->
    <div class="entries-empty">
        <div class="empty-icon">📝</div>
        <h3 class="empty-title">No expenses yet</h3>
        <p class="empty-description">
            Start tracking your spending by adding your first expense above.
        </p>
        <button class="btn btn-neutral btn-sm" onclick="focusAmountInput()">
            Add First Expense
        </button>
    </div>
{% endif %}

<script>
async function editEntry(entryId) {
    const entryElement = document.querySelector(`[data-entry-id="${entryId}"]`);
    if (!entryElement) return;
    
    // Get current values
    const currentAmount = entryElement.querySelector('.amount-value').textContent.replace('৳', '').replace(',', '').trim();
    const currentCategory = entryElement.querySelector('.amount-category').textContent.toLowerCase();
    
    // Prompt for amount
    const newAmount = prompt('Enter new amount:', currentAmount);
    if (!newAmount) return;
    
    // Validate amount
    const parsedAmount = parseFloat(newAmount);
    if (isNaN(parsedAmount) || parsedAmount <= 0) {
        showToast('Please enter a valid amount', 'error');
        return;
    }
    
    // Category editing: now allowed for all expenses
    // Include all categories from the template
    const categoryChoice = prompt(
        'Choose category:\n0 = Keep current (' + currentCategory + ')\n1 = Food\n2 = Transport\n3 = Shopping\n4 = Bills\n5 = Entertainment\n6 = Health\n7 = Education\n8 = Uncategorized',
        '0'
    );
    
    let newCategory = currentCategory;
    if (categoryChoice && categoryChoice !== '0') {
        const categoryMap = {
            '1': 'food',
            '2': 'transport',
            '3': 'shopping',
            '4': 'bills',
            '5': 'entertainment',
            '6': 'health',
            '7': 'education',
            '8': 'uncategorized'
        };
        newCategory = categoryMap[categoryChoice] || currentCategory;
    }
    
    // Check if anything changed
    if (parsedAmount === parseFloat(currentAmount) && newCategory === currentCategory) {
        showToast('No changes made', 'info');
        return;
    }
    
    try {
        entryElement.style.opacity = '0.5';
        
        const response = await fetch('/expense/quick-edit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                expense_id: entryId,
                amount: parsedAmount,
                category: newCategory
            })
        });
        
        if (response.ok) {
            showToast('Expense updated successfully!', 'success');
            // Reload page to refresh all data
            setTimeout(() => location.reload(), 500);
        } else {
            const errorText = await response.text();
            throw new Error(errorText || 'Failed to update expense');
        }
    } catch (error) {
        console.error('Error updating expense:', error);
        showToast('Failed to update expense', 'error');
        entryElement.style.opacity = '1';
    }
}

function focusAmountInput() {
    const amountInput = document.getElementById('amount');
    if (amountInput) {
        amountInput.focus();
        amountInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}
</script>