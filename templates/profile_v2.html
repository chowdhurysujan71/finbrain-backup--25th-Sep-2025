{% extends "base.html" %}

{% block title %}Profile - finbrain{% endblock %}

{% block content %}
<style>
/* Google × Stripe 2025 Design System */
:root {
    --bg: #ffffff;
    --surface: #f7f9fc;
    --surface-2: #eef2f7;
    --text: #0b1220;
    --muted: #5b667a;
    --pri: #3b6aff;
    --pri-600: #2f56db;
    --pri-050: #eef3ff;
    --good: #10b981;
    --warn: #f59e0b;
    --bad: #ef4444;
    --accent: #7c3aed;
    --ring: rgba(59,106,255,.35);
    --shadow-soft: 0 1px 2px rgba(9,12,20,.06), 0 8px 24px rgba(9,12,20,.06);
    --shadow-raise: 0 10px 20px rgba(9,12,20,.10);
    --radius: 14px;
    --radius-lg: 18px;
    --gap: 16px;
}

/* System font stack & Base styles */
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background-color: var(--bg);
    color: var(--text);
}

.profile-v2 .card {
    background: var(--surface);
    border: none;
    border-radius: var(--radius);
    box-shadow: var(--shadow-soft);
    overflow: hidden;
}

.stat-chip {
    min-width: 120px;
    padding: 12px 16px;
    background: var(--surface);
    border-radius: 12px;
    text-align: center;
    box-shadow: var(--shadow-soft);
    flex-shrink: 0;
}

.progress-ring {
    width: 88px;
    height: 88px;
}

.no-scrollbar { 
    scrollbar-width: none; 
    -ms-overflow-style: none; 
}
.no-scrollbar::-webkit-scrollbar { 
    display: none; 
}

/* Quick action buttons */
.quick-action {
    border: none;
    transition: transform 150ms ease, box-shadow 150ms ease;
    height: 100px;
    text-decoration: none;
}
.quick-action:focus-visible {
    box-shadow: 0 0 0 3px var(--ring);
    outline: none;
}
.quick-action:active {
    transform: scale(0.98);
    box-shadow: var(--shadow-soft);
}
.quick-action-primary {
    background-color: var(--pri-050);
    color: var(--pri);
}
.quick-action-primary:hover {
    background-color: #dde7ff;
    color: var(--pri);
}

.quick-action-secondary {
    background-color: var(--surface-2);
    color: var(--muted);
}
.quick-action-secondary:hover {
    background-color: #e2e8f0;
    color: #475569;
}

/* Skeleton Loader */
.skeleton {
    background-color: var(--surface-2);
    border-radius: 8px;
    animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
.skeleton-text { height: 1em; }
.skeleton-avatar { width: 56px; height: 56px; border-radius: 50%; }
.skeleton-chip { width: 120px; height: 73px; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

@media (prefers-reduced-motion: reduce) {
  .quick-action:active { transform: none; }
  .skeleton { animation: none; }
}

/* Hide until enhanced */
.live-data { display: none !important; }
.live-data.show { display: flex !important; }
</style>

<main class="container-fluid py-3" style="max-width: 428px;">
    <div class="profile-v2" data-profile-v2>
        
        <!-- Hero Header -->
        <header class="card mb-3 p-3" id="hero-section">
            <!-- Skeleton Loader -->
            <div class="d-flex align-items-center gap-3 skeleton-loader" id="hero-skeleton">
                <div class="skeleton skeleton-avatar"></div>
                <div class="flex-grow-1">
                    <div class="skeleton skeleton-text w-50 mb-2" style="height: 1.2em;"></div>
                    <div class="skeleton skeleton-text w-75" style="height: 0.9em;"></div>
                </div>
                <div class="skeleton skeleton-text" style="width: 40px; height: 0.9em;"></div>
            </div>
            <!-- Live Data (hidden until hydrated) -->
            <div class="d-flex align-items-center gap-3 live-data" id="hero-content">
                <div class="rounded-circle d-flex align-items-center justify-content-center text-white" 
                     style="width:56px;height:56px;background-color:var(--pri);">
                    <i class="fas fa-user fa-lg"></i>
                </div>
                <div class="flex-grow-1">
                    <h1 class="h5 mb-1 fw-bold">Profile</h1>
                    <div class="small" style="color: var(--muted);">
                        Member since <span id="member-since">Oct 2024</span> · 
                        <span id="acct-status" class="badge bg-success rounded-pill">Active</span>
                    </div>
                </div>
                <div class="small" style="color: var(--muted);">App <span id="app-version">v1.0</span></div>
            </div>
        </header>

        <!-- Stats Strip -->
        <section id="stats-section" class="mb-3">
            <div class="d-flex gap-2 overflow-auto no-scrollbar pb-2">
                 <!-- Skeleton Loader -->
                <div class="d-flex gap-2 skeleton-loader" id="stats-skeleton">
                    <div class="skeleton skeleton-chip"></div>
                    <div class="skeleton skeleton-chip"></div>
                    <div class="skeleton skeleton-chip"></div>
                    <div class="skeleton skeleton-chip"></div>
                    <div class="skeleton skeleton-chip"></div>
                </div>
                <!-- Live Data (populated by JS) -->
                <div class="d-flex gap-2 live-data" id="stats-content"></div>
            </div>
        </section>

        <!-- Goals & Streaks -->
        <section class="card mb-3 p-3" id="goals-section" data-percent="0">
            <!-- Skeleton Loader -->
            <div class="skeleton-loader" id="goals-skeleton">
                <div class="d-flex align-items-center gap-3">
                    <div class="skeleton" style="width: 88px; height: 88px; border-radius: 50%;"></div>
                    <div class="flex-grow-1">
                        <div class="skeleton skeleton-text w-75 mb-2"></div>
                        <div class="skeleton skeleton-text w-50 mb-2"></div>
                        <div class="skeleton skeleton-text w-100"></div>
                    </div>
                </div>
            </div>
            <!-- Live Data -->
            <div class="live-data" id="goals-content"></div>
        </section>

        <!-- Coach's Tip -->
        <section class="card mb-3 p-3" id="insights-section">
            <!-- Skeleton Loader -->
            <div class="skeleton-loader" id="insights-skeleton">
                <div class="d-flex gap-3 align-items-center">
                    <div class="skeleton" style="width: 24px; height: 24px; border-radius: 50%;"></div>
                    <div class="flex-grow-1">
                        <div class="skeleton skeleton-text w-25 mb-1"></div>
                        <div class="skeleton skeleton-text w-100"></div>
                        <div class="skeleton skeleton-text w-75"></div>
                    </div>
                    <div class="skeleton" style="width: 24px; height: 24px;"></div>
                </div>
            </div>
            <!-- Live Data -->
            <div class="live-data" id="insights-content"></div>
        </section>

        <!-- Quick Actions 2x2 -->
        <section class="row g-2 mb-3" id="quick-actions">
            <div class="col-6">
                <a href="/report?range=this_week" class="btn quick-action quick-action-primary w-100 d-flex flex-column align-items-center justify-content-center gap-2 py-3">
                    <i class="fas fa-chart-line fs-5"></i>
                    <span class="small fw-semibold">View This Week</span>
                </a>
            </div>
            <div class="col-6">
                <a href="/challenge" class="btn quick-action quick-action-primary w-100 d-flex flex-column align-items-center justify-content-center gap-2 py-3">
                    <i class="fas fa-bullseye fs-5"></i>
                    <span class="small fw-semibold">Adjust Goals</span>
                </a>
            </div>
            <div class="col-6">
                <a href="/api/export.csv" download class="btn quick-action quick-action-secondary w-100 d-flex flex-column align-items-center justify-content-center gap-2 py-3">
                    <i class="fas fa-download fs-5"></i>
                    <span class="small fw-semibold">Export CSV</span>
                </a>
            </div>
            <div class="col-6">
                <a href="/insights" class="btn quick-action quick-action-secondary w-100 d-flex flex-column align-items-center justify-content-center gap-2 py-3">
                    <i class="fas fa-lightbulb fs-5"></i>
                    <span class="small fw-semibold">See Insights</span>
                </a>
            </div>
        </section>

        <!-- Recent Activity -->
        <section class="card mb-3" id="recent-section">
            <!-- Skeleton Loader -->
            <div class="skeleton-loader" id="recent-skeleton">
                <div class="card-header bg-transparent border-0 pb-1">
                    <div class="skeleton skeleton-text w-25"></div>
                </div>
                <div class="card-body pt-2">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <div class="skeleton" style="width: 24px; height: 24px; border-radius: 50%;"></div>
                            <div>
                                <div class="skeleton skeleton-text mb-1" style="width: 60px;"></div>
                                <div class="skeleton skeleton-text" style="width: 80px; height: 0.75em;"></div>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="skeleton skeleton-text mb-1" style="width: 50px;"></div>
                            <div class="skeleton skeleton-text" style="width: 30px; height: 0.75em;"></div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <div class="skeleton" style="width: 24px; height: 24px; border-radius: 50%;"></div>
                            <div>
                                <div class="skeleton skeleton-text mb-1" style="width: 70px;"></div>
                                <div class="skeleton skeleton-text" style="width: 90px; height: 0.75em;"></div>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="skeleton skeleton-text mb-1" style="width: 45px;"></div>
                            <div class="skeleton skeleton-text" style="width: 30px; height: 0.75em;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Live Data -->
            <div class="live-data" id="recent-content"></div>
        </section>
        
        <!-- App & Settings -->
        <section class="card text-center" id="app-settings-section">
            <div class="card-body p-3">
                <div class="small text-muted mb-3">
                    finbrain v0.9.7
                </div>
                <button 
                    id="logout-btn"
                    onclick="handleLogout()" 
                    class="btn btn-sm w-100 mb-3"
                    style="background-color: var(--surface-2); color: var(--bad); border: 1px solid var(--bad); border-radius: 8px; padding: 10px; font-weight: 500; transition: all 150ms ease;">
                    <i class="fas fa-sign-out-alt me-2"></i>Sign Out
                </button>
                
                <!-- Legal Links -->
                <div class="d-flex justify-content-center gap-3 small">
                    <a href="https://www.finbrain.app/privacy-policy" target="_blank" rel="noopener noreferrer" class="text-decoration-none" style="color: var(--muted);">
                        Privacy Policy
                    </a>
                    <span style="color: var(--muted);">·</span>
                    <a href="https://www.finbrain.app/terms-of-service" target="_blank" rel="noopener noreferrer" class="text-decoration-none" style="color: var(--muted);">
                        Terms of Service
                    </a>
                </div>
            </div>
        </section>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    if (!document.querySelector('[data-profile-v2]')) return;

    const API_ENDPOINT = '/api/profile';

    // --- UTILITY FUNCTIONS ---
    const fmtBDT = (amount) => {
        if (amount >= 1000) {
            return `৳${(amount / 1000).toFixed(1)}K`;
        }
        return `৳${Math.round(amount)}`;
    };
    
    const fmtDate = (isoStr) => new Date(isoStr).toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
    });
    
    const fmtRelativeTime = (isoStr) => {
        const date = new Date(isoStr);
        const now = new Date();
        const diffSeconds = Math.round((now - date) / 1000);
        const diffDays = Math.round(diffSeconds / (60 * 60 * 24));

        if (diffSeconds < 60) return "just now";
        if (diffSeconds < 3600) return `${Math.floor(diffSeconds / 60)} minutes ago`;
        if (diffDays === 0) return `Today, ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
        if (diffDays === 1) return `Yesterday, ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    };

    const renderRing = (el, pct) => {
        const r = 40; // radius for 88px container
        const c = 2 * Math.PI * r;
        const circle = el.querySelector('circle.progress');
        if (circle) {
            circle.style.strokeDasharray = c;
            setTimeout(() => {
                circle.style.strokeDashoffset = (1 - pct) * c;
            }, 100);
        }
    };

    const showContent = (skeletonId, contentId) => {
        const skeleton = document.getElementById(skeletonId);
        const content = document.getElementById(contentId);
        if (skeleton) skeleton.style.display = 'none';
        if (content) content.classList.add('show');
    };
    
    // --- TEMPLATE GENERATORS ---
    const createStatChip = (value, label, color = 'var(--pri)') => `
        <div class="stat-chip">
            <div class="fw-bold fs-5" style="color: ${color};">${value}</div>
            <div class="small" style="color: var(--muted);">${label}</div>
        </div>`;

    const createGoalCard = ({ daily_budget, current_streak_days, ai_next_goal_suggestion }, successRate) => `
        <div class="d-flex align-items-center gap-3">
            <div class="flex-shrink-0">
                <div class="progress-ring position-relative" role="progressbar" aria-valuenow="${Math.round(successRate * 100)}" aria-valuemin="0" aria-valuemax="100">
                    <svg width="88" height="88" class="position-absolute" style="transform: rotate(-90deg);">
                        <circle cx="44" cy="44" r="40" fill="none" stroke="var(--surface-2)" stroke-width="8"/>
                        <circle cx="44" cy="44" r="40" fill="none" stroke="var(--good)" 
                                stroke-width="8" stroke-linecap="round" class="progress"
                                style="transition: stroke-dashoffset 1.2s cubic-bezier(0.25, 1, 0.5, 1);"/>
                    </svg>
                    <div class="position-absolute top-50 start-50 translate-middle text-center">
                        <div class="fw-bold fs-5">${Math.round(successRate * 100)}%</div>
                        <div class="small" style="color: var(--muted);">Goal</div>
                    </div>
                </div>
            </div>
            <div class="flex-grow-1">
                <h3 class="fs-6 fw-semibold mb-2">Daily Budget: ${fmtBDT(daily_budget)}</h3>
                <div class="d-flex align-items-center gap-2 mb-2">
                    <span style="color: #f59e0b;">🔥</span>
                    <span class="small" style="color: var(--muted);">${current_streak_days}-day streak</span>
                </div>
                <div class="small" style="color: var(--muted);">Next goal: Try ${fmtBDT(ai_next_goal_suggestion)} for better consistency</div>
            </div>
        </div>`;
    
    const createInsightCard = ({top_tip, trend}) => `
        <div class="d-flex gap-3 align-items-center">
            <div style="color: var(--pri); font-size: 1.5rem;">💡</div>
            <div class="flex-grow-1">
                <div class="fw-semibold small mb-1">Coach's tip</div>
                <div class="small" style="color: var(--muted);">${top_tip}</div>
            </div>
            <div style="color: var(--${trend === 'up' ? 'warn' : 'good'}); font-size: 1.5rem;">
                ${trend === 'up' ? '↗' : '↘'}
            </div>
        </div>`;

    const createRecentCard = (items) => `
        <div class="card-header bg-transparent border-0 pb-1">
            <h3 class="fs-6 mb-0 fw-semibold">Latest activity</h3>
        </div>
        <div class="card-body pt-2">
            ${items.map(item => `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <span style="font-size: 1.5rem;">${getCategoryIcon(item.category)}</span>
                        <div>
                            <div class="small fw-medium">${item.note || item.category}</div>
                            <div style="font-size: 0.75rem; color: var(--muted);">${fmtRelativeTime(item.ts)}</div>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-medium">${fmtBDT(item.amount)}</div>
                        <a href="/expense/${item.id}" class="text-decoration-none" style="font-size: 0.75rem; color: var(--muted);">edit</a>
                    </div>
                </div>
            `).join('')}
        </div>`;

    const getCategoryIcon = (category) => {
        const icons = {
            'Food': '🍽️',
            'Transport': '🚌',
            'Shopping': '🛒',
            'Entertainment': '🎮',
            'Health': '🏥',
            'Education': '📚',
            'Utilities': '💡',
            'Coffee': '☕',
            'Default': '💰'
        };
        return icons[category] || icons['Default'];
    };

    // --- PROGRESSIVE ENHANCEMENT ---
    const enhanceProfile = async () => {
        try {
            // Show skeletons first (already visible)
            console.log('Loading profile data...');
            
            // Try to load real data
            const response = await fetch(API_ENDPOINT, { 
                credentials: 'include',
                headers: {
                    'Cache-Control': 'no-store'
                }
            });
            
            if (!response.ok) {
                throw new Error(`API returned ${response.status}`);
            }
            
            const data = await response.json();
            
            // Enhance Hero Section
            if (data.user) {
                document.getElementById('member-since').textContent = fmtDate(data.user.member_since);
                document.getElementById('app-version').textContent = data.user.app_version;
                showContent('hero-skeleton', 'hero-content');
            }

            // Enhance Stats Section
            if (data.stats) {
                const statsHTML = [
                    createStatChip(data.stats.expense_count, 'Expenses'),
                    createStatChip(fmtBDT(data.stats.total_spent), 'This Month'),
                    createStatChip(data.stats.active_days, 'Active Days'),
                    createStatChip(data.stats.category_count, 'Categories'),
                    createStatChip(`${Math.round(data.stats.goal_success_rate * 100)}%`, 'Goal Success', 'var(--good)')
                ].join('');
                
                document.getElementById('stats-content').innerHTML = statsHTML;
                showContent('stats-skeleton', 'stats-content');
            }

            // Enhance Goals Section
            if (data.goals && data.stats) {
                const goalsHTML = createGoalCard(data.goals, data.stats.goal_success_rate);
                document.getElementById('goals-content').innerHTML = goalsHTML;
                showContent('goals-skeleton', 'goals-content');
                
                // Animate progress ring
                setTimeout(() => {
                    const ringEl = document.querySelector('#goals-content .progress-ring');
                    if (ringEl) renderRing(ringEl, data.stats.goal_success_rate);
                }, 200);
            }

            // Enhance Insights Section
            if (data.insights) {
                const insightsHTML = createInsightCard(data.insights);
                document.getElementById('insights-content').innerHTML = insightsHTML;
                showContent('insights-skeleton', 'insights-content');
            }

            // Enhance Recent Section
            if (data.recent && data.recent.length > 0) {
                const recentHTML = createRecentCard(data.recent.slice(0, 3));
                document.getElementById('recent-content').innerHTML = recentHTML;
                showContent('recent-skeleton', 'recent-content');
            }

            console.log('Profile enhanced successfully');
            
        } catch (error) {
            console.error('Profile data loading failed:', error.message);
            
            // Zero hallucination: Show error message instead of fake data
            // Hide skeletons and show error state
            document.getElementById('hero-skeleton').style.display = 'none';
            document.getElementById('stats-skeleton').style.display = 'none';
            document.getElementById('goals-skeleton').style.display = 'none';
            document.getElementById('insights-skeleton').style.display = 'none';
            document.getElementById('recent-skeleton').style.display = 'none';
            
            // Show error message in hero section
            const heroContent = document.getElementById('hero-content');
            if (heroContent) {
                heroContent.innerHTML = `
                    <div class="d-flex align-items-center gap-3 w-100 justify-content-center text-center">
                        <div class="text-muted">
                            <i class="fas fa-exclamation-circle fs-4 mb-2"></i>
                            <p class="mb-0">Unable to load profile data</p>
                            <p class="small">Please refresh the page to try again</p>
                        </div>
                    </div>
                `;
                heroContent.classList.add('show');
            }
        }
    };

    // Start enhancement
    enhanceProfile();
});

// Logout handler
async function handleLogout() {
    const logoutBtn = document.getElementById('logout-btn');
    if (!logoutBtn) return;
    
    // Disable button during request
    logoutBtn.disabled = true;
    logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Signing out...';
    
    try {
        const response = await fetch('/auth/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Redirect immediately to login
            window.location.href = '/login';
        } else {
            // Re-enable button on error
            logoutBtn.disabled = false;
            logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt me-2"></i>Sign Out';
            alert('Logout failed. Please try again.');
        }
    } catch (error) {
        console.error('Logout error:', error);
        // Re-enable button on error
        logoutBtn.disabled = false;
        logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt me-2"></i>Sign Out';
        alert('Connection error during logout. Please try again.');
    }
}
</script>

{% endblock %}