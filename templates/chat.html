{% extends "base.html" %}

{% block title %}Chat - finbrain{% endblock %}

{% block head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Hero Section -->
    <header class="hero-section">
        <h1 class="hero-title">Track your expenses</h1>
        <p class="hero-subtitle">Quick logging with AI-powered insights</p>
    </header>

    <!-- Chat Now Active -->
    <section class="card chat-preview-banner">
        <div class="alert alert-success">
            <h2>💬 Chat Feature - Now Live!</h2>
            <p><strong>Chat with finbrain AI is now active.</strong></p>
            <p>Try saying "I spent 200 taka on lunch" or ask for spending insights!</p>
        </div>
    </section>

    <!-- Active Chat Interface -->
    <section class="card chat-card" aria-labelledby="chat-title">
        <h2 id="chat-title" class="card-title">💬 Chat with finbrain AI</h2>
        
        <!-- Chat Messages -->
        <div id="chat-error" class="alert alert-danger" style="display: none;"></div>
        <div id="chat-messages" class="chat-messages">
            <div class="message ai-message">
                <div class="message-avatar">🤖</div>
                <div class="message-content">
                    <p>Hi! I'm your AI expense assistant. You can:</p>
                    <ul>
                        <li>📝 Say "I spent 500 taka on lunch" to log expenses</li>
                        <li>📊 Ask "Show my spending summary"</li>
                        <li>💡 Get insights: "How's my spending this month?"</li>
                        <li>🎯 Ask for financial advice and tips</li>
                    </ul>
                    <p>Just type naturally - I'll understand! 😊</p>
                </div>
            </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-container">
            <form id="chat-form" class="chat-form">
                <div class="chat-input-group">
                    <textarea id="chat-input" name="message" class="chat-input" 
                              placeholder="Type your message... (e.g., 'I spent 200 taka on groceries')"
                              rows="2" maxlength="500"></textarea>
                    <button type="submit" class="btn btn-primary chat-send-btn" id="chat-send">
                        <span class="btn-text">Send</span>
                        <span id="chat-spinner" class="btn-loading" style="display: none;">⏳</span>
                    </button>
                </div>
                <div class="chat-suggestions">
                    <button type="button" class="suggestion-btn" onclick="fillChatInput('Show my expenses this week')">
                        📊 Weekly summary
                    </button>
                    <button type="button" class="suggestion-btn" onclick="fillChatInput('I spent 300 taka on dinner')">
                        💰 Log expense
                    </button>
                    <button type="button" class="suggestion-btn" onclick="fillChatInput('Give me some budgeting tips')">
                        💡 Get tips
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Recent Expenses (populated by JavaScript) -->
        <div id="recent-expenses-list" class="recent-expenses-list" style="margin-top: 1rem;">
        </div>
    </section>

    <!-- Quick Form (Alternative) -->
    <section class="card expense-form-card" aria-labelledby="quick-form-title">
        <h2 id="quick-form-title" class="card-title">⚡ Quick Add</h2>
        <p class="card-subtitle">Prefer forms? Use this quick expense entry</p>
        
        <!-- Success/Error Messages -->
        <div id="form-messages" class="form-messages" style="display: none;"></div>
        
        <form id="expense-form" class="expense-form" hx-post="/expense" 
              hx-trigger="submit" hx-target="#form-messages" hx-swap="innerHTML"
              hx-on::after-request="handleFormResponse(event)"
              hx-headers='{"Content-Type": "application/x-www-form-urlencoded"}'>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="amount" class="form-label">Amount</label>
                    <div class="input-group">
                        <span class="input-prefix">৳</span>
                        <input type="number" id="amount" name="amount" 
                               class="form-input" placeholder="0.00" 
                               step="0.01" min="0" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="category" class="form-label">Category</label>
                    <select id="category" name="category" class="form-select" required>
                        <option value="">Choose</option>
                        <option value="food">🍽️ Food</option>
                        <option value="transport">🚗 Transport</option>
                        <option value="shopping">🛍️ Shopping</option>
                        <option value="bills">💡 Bills</option>
                        <option value="entertainment">🎬 Fun</option>
                        <option value="health">🏥 Health</option>
                        <option value="education">📚 Education</option>
                        <option value="other">📝 Other</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="description" class="form-label">Description</label>
                <input type="text" id="description" name="description" 
                       class="form-input" placeholder="What did you buy?"
                       maxlength="100">
            </div>

            <button type="submit" class="btn btn-primary btn-full" id="submit-btn">
                Add Expense
            </button>
        </form>
    </section>
    
    <script>
    // HTML escape utility
    function escapeHtml(s) {
        return s.replace(/[&<>"']/g, m => ({
            '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[m]));
    }
    
    // Chat suggestion functionality
    function fillChatInput(suggestion) {
        const input = document.getElementById('chat-input');
        if (input) {
            input.value = suggestion;
            input.focus();
        }
    }
    
    // Auto-resize textarea (with safety check)
    document.addEventListener('DOMContentLoaded', () => {
        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
        }
    });

    // Form handling for quick add
    async function handleFormResponse(event) {
        const xhr = event.detail.xhr;
        const response = JSON.parse(xhr.responseText);
        const messagesDiv = document.getElementById('form-messages');
        const form = document.getElementById('expense-form');
        const submitBtn = document.getElementById('submit-btn');
        
        // Show messages div
        messagesDiv.style.display = 'block';
        
        if (response.success) {
            // Success message
            messagesDiv.innerHTML = `
                <div class="alert alert-success">
                    <span class="alert-icon">✅</span>
                    <span class="alert-message">${response.message}</span>
                </div>
            `;
            
            // Clear the form
            form.reset();
            
            // Also trigger HTMX refresh for backward compatibility
            htmx.trigger('#entries-section', 'expense-added');
            
            // Auto-hide success message after 3 seconds
            setTimeout(() => {
                messagesDiv.style.display = 'none';
            }, 3000);
            
        } else {
            // Error message
            messagesDiv.innerHTML = `
                <div class="alert alert-error">
                    <span class="alert-icon">❌</span>
                    <span class="alert-message">${response.message}</span>
                </div>
            `;
        }
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Expense';
    }
    
    // Disable submit button during submission
    document.getElementById('expense-form').addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';
    });
    </script>
    

    <!-- Recent Entries Section -->
    <section class="entries-section" aria-labelledby="recent-entries-title">
        <h2 id="recent-entries-title" class="section-title">Recent Expenses</h2>
        
        <div id="entries-section" 
             hx-get="/partials/entries" 
             hx-trigger="load, expense-added from:body"
             hx-target="this"
             hx-swap="innerHTML">
            <!-- Recent entries will load here via HTMX -->
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading recent expenses...</p>
            </div>
        </div>
    </section>
</div>


<!-- keep just this; remove older script tags -->
<script src="/static/js/chat-handler.js?NUCLEAR={{ timestamp }}&bust={{ timestamp }}" defer></script>
{% endblock %}