{% extends "base.html" %}

{% block title %}Chat - FinBrain{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Hero Section -->
    <header class="hero-section">
        <h1 class="hero-title">Track your expenses</h1>
        <p class="hero-subtitle">Quick logging with AI-powered insights</p>
    </header>

    <!-- AI Chat Interface -->
    <section class="card chat-card" aria-labelledby="chat-title">
        <h2 id="chat-title" class="card-title">ğŸ’¬ Chat with FinBrain AI</h2>
        
        <!-- Chat Messages -->
        <div id="chat-messages" class="chat-messages">
            <div class="message ai-message">
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <p>Hi! I'm your AI expense assistant. You can:</p>
                    <ul>
                        <li>ğŸ“ Say "I spent 500 taka on lunch" to log expenses</li>
                        <li>ğŸ“Š Ask "Show my spending summary"</li>
                        <li>ğŸ’¡ Get insights: "How's my spending this month?"</li>
                        <li>ğŸ¯ Ask for financial advice and tips</li>
                    </ul>
                    <p>Just type naturally - I'll understand! ğŸ˜Š</p>
                </div>
            </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-container">
            <form id="chat-form" class="chat-form">
                <div class="chat-input-group">
                    <textarea id="chat-input" name="message" class="chat-input" 
                              placeholder="Type your message... (e.g., 'I spent 200 taka on groceries')"
                              rows="2" maxlength="500"></textarea>
                    <button type="submit" class="btn btn-primary chat-send-btn" id="chat-send-btn">
                        <span class="btn-text">Send</span>
                        <span class="btn-loading" style="display: none;">...</span>
                    </button>
                </div>
                <div class="chat-suggestions">
                    <button type="button" class="suggestion-btn" onclick="fillChatInput('Show my expenses this week')">
                        ğŸ“Š Weekly summary
                    </button>
                    <button type="button" class="suggestion-btn" onclick="fillChatInput('I spent 300 taka on dinner')">
                        ğŸ’° Log expense
                    </button>
                    <button type="button" class="suggestion-btn" onclick="fillChatInput('Give me some budgeting tips')">
                        ğŸ’¡ Get tips
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- Quick Form (Alternative) -->
    <section class="card expense-form-card" aria-labelledby="quick-form-title">
        <h2 id="quick-form-title" class="card-title">âš¡ Quick Add</h2>
        <p class="card-subtitle">Prefer forms? Use this quick expense entry</p>
        
        <!-- Success/Error Messages -->
        <div id="form-messages" class="form-messages" style="display: none;"></div>
        
        <form id="expense-form" class="expense-form" hx-post="/expense" 
              hx-trigger="submit" hx-target="#form-messages" hx-swap="innerHTML"
              hx-on::after-request="handleFormResponse(event)"
              hx-headers='{"Content-Type": "application/x-www-form-urlencoded"}'>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="amount" class="form-label">Amount</label>
                    <div class="input-group">
                        <span class="input-prefix">à§³</span>
                        <input type="number" id="amount" name="amount" 
                               class="form-input" placeholder="0.00" 
                               step="0.01" min="0" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="category" class="form-label">Category</label>
                    <select id="category" name="category" class="form-select" required>
                        <option value="">Choose</option>
                        <option value="food">ğŸ½ï¸ Food</option>
                        <option value="transport">ğŸš— Transport</option>
                        <option value="shopping">ğŸ›ï¸ Shopping</option>
                        <option value="bills">ğŸ’¡ Bills</option>
                        <option value="entertainment">ğŸ¬ Fun</option>
                        <option value="health">ğŸ¥ Health</option>
                        <option value="education">ğŸ“š Education</option>
                        <option value="other">ğŸ“ Other</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="description" class="form-label">Description</label>
                <input type="text" id="description" name="description" 
                       class="form-input" placeholder="What did you buy?"
                       maxlength="100">
            </div>

            <button type="submit" class="btn btn-primary btn-full" id="submit-btn">
                Add Expense
            </button>
        </form>
    </section>
    
    <script>
    // Chat functionality
    function fillChatInput(suggestion) {
        document.getElementById('chat-input').value = suggestion;
        document.getElementById('chat-input').focus();
    }
    
    function appendMessage(content, isAi = false, isLoading = false) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isAi ? 'ai-message' : 'user-message'}`;
        
        if (isLoading) {
            messageDiv.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="message-avatar">${isAi ? 'ğŸ¤–' : 'ğŸ‘¤'}</div>
                <div class="message-content">
                    <p>${content}</p>
                </div>
            `;
        }
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        return messageDiv;
    }
    
    function handleChatSubmit(event) {
        event.preventDefault();
        
        const input = document.getElementById('chat-input');
        const sendBtn = document.getElementById('chat-send-btn');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Show user message
        appendMessage(message, false);
        
        // Clear input and disable button
        input.value = '';
        sendBtn.disabled = true;
        sendBtn.querySelector('.btn-text').style.display = 'none';
        sendBtn.querySelector('.btn-loading').style.display = 'inline';
        
        // Show loading indicator
        const loadingMessage = appendMessage('', true, true);
        
        // Multiple timeout protection layers
        let requestCompleted = false;
        let timeoutIds = [];
        
        const userId = getUserId();
        
        // Emergency UI recovery timeout (5 seconds)
        const emergencyTimeoutId = setTimeout(() => {
            if (!requestCompleted) {
                requestCompleted = true;
                loadingMessage.remove();
                appendMessage('âš ï¸ Request taking too long. Please try again.', true);
                // Force button recovery
                sendBtn.disabled = false;
                sendBtn.querySelector('.btn-text').style.display = 'inline';
                sendBtn.querySelector('.btn-loading').style.display = 'none';
                input.focus();
            }
        }, 5000);
        timeoutIds.push(emergencyTimeoutId);
        
        // Robust fetch implementation with browser compatibility
        const makeRequest = () => {
            // Browser compatibility check for AbortController
            let controller = null;
            let signal = null;
            
            if (typeof AbortController !== 'undefined') {
                controller = new AbortController();
                signal = controller.signal;
                
                const abortTimeoutId = setTimeout(() => {
                    if (!requestCompleted && controller) {
                        controller.abort();
                    }
                }, 10000); // 10 second abort timeout
                timeoutIds.push(abortTimeoutId);
            }
            
            const fetchPromise = fetch('/ai-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                },
                body: JSON.stringify({ message: message }),
                signal: signal
            });
            
            // Race between fetch and manual timeout
            const timeoutPromise = new Promise((_, reject) => {
                const manualTimeoutId = setTimeout(() => {
                    reject(new Error('Manual timeout'));
                }, 8000); // 8 second manual timeout
                timeoutIds.push(manualTimeoutId);
            });
            
            return Promise.race([fetchPromise, timeoutPromise]);
        };
        
        makeRequest()
        .then(response => {
            if (requestCompleted) return null;
            
            // Check if response is ok
            if (!response.ok) {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }
            
            return response.json();
        })
        .then(data => {
            if (requestCompleted || !data) return;
            requestCompleted = true;
            
            // Clear all timeouts
            timeoutIds.forEach(id => clearTimeout(id));
            
            // Remove loading indicator
            loadingMessage.remove();
            
            // Show AI response
            if (data.success) {
                appendMessage(data.response, true);
                
                // If expense was logged, refresh entries
                if (data.expense_logged) {
                    htmx.trigger('#entries-section', 'expense-added');
                }
            } else {
                appendMessage(data.error || 'Sorry, I encountered an error. Please try again.', true);
            }
        })
        .catch(error => {
            if (requestCompleted) return;
            requestCompleted = true;
            
            // Clear all timeouts
            timeoutIds.forEach(id => clearTimeout(id));
            
            // Remove loading indicator
            loadingMessage.remove();
            
            // Handle different types of errors
            if (error.name === 'AbortError' || error.message === 'Manual timeout') {
                appendMessage('â±ï¸ Request timed out. Please try again.', true);
            } else if (error.message.includes('Server error')) {
                appendMessage('ğŸ”§ Server is having issues. Please try again in a moment.', true);
            } else if (typeof navigator !== 'undefined' && !navigator.onLine) {
                appendMessage('ğŸ“¡ No internet connection. Please check your network and try again.', true);
            } else {
                appendMessage('âŒ Connection error. Please try again.', true);
            }
            
            // Log error for debugging without exposing to user
            if (typeof console !== 'undefined') console.error('Chat error:', error);
        })
        .finally(() => {
            // Re-enable button
            sendBtn.disabled = false;
            sendBtn.querySelector('.btn-text').style.display = 'inline';
            sendBtn.querySelector('.btn-loading').style.display = 'none';
            input.focus();
        });
    }
    
    function getUserId() {
        // Get user ID from session or generate one for PWA
        let userId = sessionStorage.getItem('pwa-user-id');
        if (!userId) {
            userId = 'pwa-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('pwa-user-id', userId);
        }
        return userId;
    }
    
    // Attach chat form handler
    const chatForm = document.getElementById('chat-form');
    if (chatForm) {
        chatForm.addEventListener('submit', handleChatSubmit);
    }
    
    // Auto-resize textarea
    document.getElementById('chat-input').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });
    
    // Form handling for quick add
    function handleFormResponse(event) {
        const xhr = event.detail.xhr;
        const response = JSON.parse(xhr.responseText);
        const messagesDiv = document.getElementById('form-messages');
        const form = document.getElementById('expense-form');
        const submitBtn = document.getElementById('submit-btn');
        
        // Show messages div
        messagesDiv.style.display = 'block';
        
        if (response.success) {
            // Success message
            messagesDiv.innerHTML = `
                <div class="alert alert-success">
                    <span class="alert-icon">âœ…</span>
                    <span class="alert-message">${response.message}</span>
                </div>
            `;
            
            // Clear the form
            form.reset();
            
            // Refresh entries list
            htmx.trigger('#entries-section', 'expense-added');
            
            // Auto-hide success message after 3 seconds
            setTimeout(() => {
                messagesDiv.style.display = 'none';
            }, 3000);
            
        } else {
            // Error message
            messagesDiv.innerHTML = `
                <div class="alert alert-error">
                    <span class="alert-icon">âŒ</span>
                    <span class="alert-message">${response.message}</span>
                </div>
            `;
        }
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Expense';
    }
    
    // Disable submit button during submission
    document.getElementById('expense-form').addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';
        
        // User ID is now working - debug removed
    });
    </script>

    <!-- Recent Entries Section -->
    <section class="entries-section" aria-labelledby="recent-entries-title">
        <h2 id="recent-entries-title" class="section-title">Recent Expenses</h2>
        
        <div id="entries-section" 
             hx-get="/partials/entries" 
             hx-trigger="load, expense-added from:body"
             hx-target="this"
             hx-swap="innerHTML">
            <!-- Recent entries will load here via HTMX -->
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading recent expenses...</p>
            </div>
        </div>
    </section>
</div>

<script>
// Enhanced form handling
document.getElementById('expense-form').addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.successful) {
        // Reset form
        this.reset();
        
        // Show success toast
        showToast('Expense added successfully!', 'success');
        
        // Trigger entries refresh
        document.body.dispatchEvent(new CustomEvent('expense-added'));
    } else {
        // Show error toast
        showToast('Failed to add expense. Please try again.', 'error');
    }
});

// Toast helper function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-message">${message}</span>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
        </div>
    `;
    
    document.getElementById('toast-container').appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}
</script>
{% endblock %}