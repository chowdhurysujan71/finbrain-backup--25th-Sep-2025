{% extends "base.html" %}

{% block title %}Chat - FinBrain{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Hero Section -->
    <header class="hero-section">
        <h1 class="hero-title">Track your expenses</h1>
        <p class="hero-subtitle">Quick logging with AI-powered insights</p>
    </header>

    <!-- Expense Input Card -->
    <section class="card expense-form-card" aria-labelledby="expense-form-title">
        <h2 id="expense-form-title" class="card-title">Add Expense</h2>
        
        <!-- Success/Error Messages -->
        <div id="form-messages" class="form-messages" style="display: none;"></div>
        
        <form id="expense-form" class="expense-form" hx-post="/expense" 
              hx-trigger="submit" hx-target="#form-messages" hx-swap="innerHTML"
              hx-on::after-request="handleFormResponse(event)"
              hx-headers='{"Content-Type": "application/x-www-form-urlencoded"}'>
            
            <div class="form-group">
                <label for="amount" class="form-label">Amount</label>
                <div class="input-group">
                    <span class="input-prefix">à§³</span>
                    <input type="number" id="amount" name="amount" 
                           class="form-input" placeholder="0.00" 
                           step="0.01" min="0" required 
                           aria-describedby="amount-help">
                </div>
                <small id="amount-help" class="form-help">Enter the expense amount</small>
            </div>

            <div class="form-group">
                <label for="category" class="form-label">Category</label>
                <select id="category" name="category" class="form-select" required>
                    <option value="">Choose category</option>
                    <option value="food">ğŸ½ï¸ Food & Dining</option>
                    <option value="transport">ğŸš— Transport</option>
                    <option value="shopping">ğŸ›ï¸ Shopping</option>
                    <option value="bills">ğŸ’¡ Bills & Utilities</option>
                    <option value="entertainment">ğŸ¬ Entertainment</option>
                    <option value="health">ğŸ¥ Health & Medical</option>
                    <option value="education">ğŸ“š Education</option>
                    <option value="other">ğŸ“ Other</option>
                </select>
            </div>

            <div class="form-group">
                <label for="description" class="form-label">Description</label>
                <input type="text" id="description" name="description" 
                       class="form-input" placeholder="What did you buy?"
                       maxlength="100" aria-describedby="description-help">
                <small id="description-help" class="form-help">Brief description (optional)</small>
            </div>

            <button type="submit" class="btn btn-primary btn-full" id="submit-btn">
                Add Expense
            </button>
        </form>
    </section>
    
    <script>
    function handleFormResponse(event) {
        const xhr = event.detail.xhr;
        const response = JSON.parse(xhr.responseText);
        const messagesDiv = document.getElementById('form-messages');
        const form = document.getElementById('expense-form');
        const submitBtn = document.getElementById('submit-btn');
        
        // Show messages div
        messagesDiv.style.display = 'block';
        
        if (response.success) {
            // Success message
            messagesDiv.innerHTML = `
                <div class="alert alert-success">
                    <span class="alert-icon">âœ…</span>
                    <span class="alert-message">${response.message}</span>
                </div>
            `;
            
            // Clear the form
            form.reset();
            
            // Refresh entries list
            htmx.trigger('#entries-section', 'expense-added');
            
            // Auto-hide success message after 3 seconds
            setTimeout(() => {
                messagesDiv.style.display = 'none';
            }, 3000);
            
        } else {
            // Error message
            messagesDiv.innerHTML = `
                <div class="alert alert-error">
                    <span class="alert-icon">âŒ</span>
                    <span class="alert-message">${response.message}</span>
                </div>
            `;
        }
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Expense';
    }
    
    // Disable submit button during submission
    document.getElementById('expense-form').addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';
        
        // Debug: Log the user ID being sent
        if (window.finbrainUserId) {
            console.log('[PWA] Submitting expense for user:', window.finbrainUserId);
        }
    });
    </script>

    <!-- Recent Entries Section -->
    <section class="entries-section" aria-labelledby="recent-entries-title">
        <h2 id="recent-entries-title" class="section-title">Recent Expenses</h2>
        
        <div id="entries-section" 
             hx-get="/partials/entries" 
             hx-trigger="load, expense-added from:body"
             hx-target="this"
             hx-swap="innerHTML">
            <!-- Recent entries will load here via HTMX -->
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading recent expenses...</p>
            </div>
        </div>
    </section>
</div>

<script>
// Enhanced form handling
document.getElementById('expense-form').addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.successful) {
        // Reset form
        this.reset();
        
        // Show success toast
        showToast('Expense added successfully!', 'success');
        
        // Trigger entries refresh
        document.body.dispatchEvent(new CustomEvent('expense-added'));
    } else {
        // Show error toast
        showToast('Failed to add expense. Please try again.', 'error');
    }
});

// Toast helper function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-message">${message}</span>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
        </div>
    `;
    
    document.getElementById('toast-container').appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}
</script>
{% endblock %}