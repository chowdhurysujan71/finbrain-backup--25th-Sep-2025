{% extends "base.html" %}

{% block title %}Chat - finbrain{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Hero Section -->
    <header class="hero-section">
        <h1 class="hero-title">Track your expenses</h1>
        <p class="hero-subtitle">Quick logging with AI-powered insights</p>
    </header>

    <!-- Smart Nudges Banner (hidden by default, shown via JavaScript) -->
    <section id="smart-banner" class="card smart-banner" style="display: none;">
        <div class="alert" id="banner-content">
            <!-- Banner content will be populated by JavaScript -->
        </div>
    </section>
    
    <!-- Progress Ring (populated by atomic cascade) -->
    <div id="progress-ring" class="card" style="display: none; margin-bottom: 1rem;">
        <!-- Progress ring content populated by JavaScript -->
    </div>
    
    <!-- Expense Chart (placeholder for future System 3) -->
    <div id="expense-chart" style="display: none;">
        <!-- Chart will be rendered here when Chart.js integration is added -->
    </div>

    <!-- Chat Now Active -->
    <section class="card chat-preview-banner">
        <div class="alert alert-success">
            <h2>💬 Chat Feature - Now Live!</h2>
            <p><strong>Chat with finbrain AI is now active.</strong></p>
            <p>Try saying "I spent 200 taka on lunch" or ask for spending insights!</p>
        </div>
    </section>

    <!-- Active Chat Interface -->
    <section class="card chat-card" aria-labelledby="chat-title">
        <h2 id="chat-title" class="card-title">💬 Chat with finbrain AI</h2>
        
        <!-- Chat Messages -->
        <div id="chat-error" class="alert alert-danger" style="display: none;"></div>
        <div id="chat-messages" class="chat-messages">
            <div class="message ai-message">
                <div class="message-avatar">🤖</div>
                <div class="message-content">
                    <p>Hi! I'm your AI expense assistant. You can:</p>
                    <ul>
                        <li>📝 Say "I spent 500 taka on lunch" to log expenses</li>
                        <li>📊 Ask "Show my spending summary"</li>
                        <li>💡 Get insights: "How's my spending this month?"</li>
                        <li>🎯 Ask for financial advice and tips</li>
                    </ul>
                    <p>Just type naturally - I'll understand! 😊</p>
                </div>
            </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-container">
            <form id="chat-form" class="chat-form">
                <div class="chat-input-group">
                    <textarea id="chat-input" name="message" class="chat-input" 
                              placeholder="Type your message... (e.g., 'I spent 200 taka on groceries')"
                              rows="2" maxlength="500"></textarea>
                    <button type="submit" class="btn btn-primary chat-send-btn" id="chat-send">
                        <span class="btn-text">Send</span>
                        <span id="chat-spinner" class="btn-loading" style="display: none;">⏳</span>
                    </button>
                </div>
                <div class="chat-suggestions">
                    <button type="button" class="suggestion-btn" onclick="fillChatInput('Show my expenses this week')">
                        📊 Weekly summary
                    </button>
                    <button type="button" class="suggestion-btn" onclick="fillChatInput('I spent 300 taka on dinner')">
                        💰 Log expense
                    </button>
                    <button type="button" class="suggestion-btn" onclick="fillChatInput('Give me some budgeting tips')">
                        💡 Get tips
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Recent Expenses (populated by JavaScript) -->
        <div id="recent-expenses-list" class="recent-expenses-list" style="margin-top: 1rem;">
        </div>
    </section>

    <script>
    // HTML escape utility
    function escapeHtml(s) {
        return s.replace(/[&<>"']/g, m => ({
            '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[m]));
    }
    
    // Chat suggestion functionality
    function fillChatInput(suggestion) {
        const input = document.getElementById('chat-input');
        if (input) {
            input.value = suggestion;
            input.focus();
        }
    }
    
    // Auto-resize textarea (with safety check)
    document.addEventListener('DOMContentLoaded', () => {
        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
        }
    });

    // Legacy form handlers removed - chat is the only entry point
    
    // Smart Banner functionality
    async function loadSmartBanners() {
        try {
            const response = await fetch('/api/banners', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (Array.isArray(data.banners) && data.banners.length > 0) {
                    displayBanner(data.banners[0]); // Show first active banner
                    hideStaticPreviewBanner(); // Hide static banner to avoid stacking
                }
            } else if (response.status === 404 || response.status === 401 || response.status === 403) {
                // Feature not available or disabled, silently skip
                return;
            } else {
                console.warn('Smart banner API error:', response.status);
            }
        } catch (error) {
            console.warn('Smart banner loading failed:', error);
            // Silently fail - this is an enhancement feature
        }
    }
    
    function displayBanner(banner) {
        const bannerContainer = document.getElementById('smart-banner');
        const bannerContent = document.getElementById('banner-content');
        
        if (!bannerContainer || !bannerContent) return;
        
        // Use banner.style if provided (with mapping), otherwise map from banner_type
        let alertClass = 'alert-info'; // default
        if (banner.style) {
            // Map semantic styles to Bootstrap classes
            const styleMapping = {
                'error': 'alert-danger',
                'warning': 'alert-warning', 
                'info': 'alert-info',
                'success': 'alert-success',
                'primary': 'alert-primary'
            };
            alertClass = styleMapping[banner.style] || banner.style; // fallback to original if already Bootstrap format
        } else {
            const alertTypes = {
                'spending_alert': 'alert-warning',
                'savings_tip': 'alert-info', 
                'achievement': 'alert-success',
                'reminder': 'alert-primary'
            };
            alertClass = alertTypes[banner.banner_type] || 'alert-info';
        }
        bannerContent.className = `alert ${alertClass}`;
        
        // Build banner HTML with better styling
        bannerContent.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="banner-text flex-grow-1">
                    <h5 class="alert-heading mb-2 fw-semibold">${escapeHtml(banner.title)}</h5>
                    <p class="mb-3 text-muted">${escapeHtml(banner.message)}</p>
                    ${banner.action_text ? `<a href="${escapeHtml(banner.action_url)}" class="btn btn-sm btn-outline-primary">${escapeHtml(banner.action_text)}</a>` : ''}
                </div>
                <button type="button" class="btn-close ms-3" onclick="dismissBanner('${banner.id}')" aria-label="Dismiss"></button>
            </div>
        `;
        
        bannerContainer.style.display = 'block';
    }
    
    async function dismissBanner(bannerId) {
        try {
            const response = await fetch(`/api/banners/${bannerId}/dismiss`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                // Hide banner with smooth animation
                const bannerContainer = document.getElementById('smart-banner');
                if (bannerContainer) {
                    bannerContainer.style.transition = 'opacity 0.3s ease';
                    bannerContainer.style.opacity = '0';
                    setTimeout(() => {
                        bannerContainer.style.display = 'none';
                        bannerContainer.style.opacity = '1';
                    }, 300);
                }
            }
        } catch (error) {
            console.warn('Banner dismiss failed:', error);
        }
    }
    
    // Hide static preview banner to avoid stacking
    function hideStaticPreviewBanner() {
        const staticBanner = document.querySelector('.chat-preview-banner');
        if (staticBanner) {
            staticBanner.style.display = 'none';
        }
    }
    
    // Load banners when page loads
    document.addEventListener('DOMContentLoaded', () => {
        loadSmartBanners();
    });
    </script>
    

    <!-- Recent Entries Section -->
    <section class="entries-section" aria-labelledby="recent-entries-title">
        <h2 id="recent-entries-title" class="section-title">Recent Expenses</h2>
        
        <div id="entries-section" 
             hx-get="/partials/entries" 
             hx-trigger="load, expense-added from:body"
             hx-target="this"
             hx-swap="innerHTML">
            <!-- Recent entries will load here via HTMX -->
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading recent expenses...</p>
            </div>
        </div>
    </section>
</div>


<!-- keep just this; remove older script tags -->
<script src="/static/js/chat-handler.js?v=20250930_2" defer></script>
{% endblock %}