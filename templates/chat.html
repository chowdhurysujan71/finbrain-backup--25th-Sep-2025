{% extends "base.html" %}

{% block title %}Chat - finbrain{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Hero Section -->
    <header class="hero-section">
        <h1 class="hero-title">Track your expenses</h1>
        <p class="hero-subtitle">Quick logging with AI-powered insights</p>
    </header>

    <!-- Smart Nudges Banner (HTMX-powered, updates on expense-added event) -->
    <section id="smart-banner" class="card smart-banner">
        <div id="banner-content"
             hx-get="/partials/banner" 
             hx-trigger="load, expense-added from:body"
             hx-swap="innerHTML">
            <!-- Banner content will be populated by HTMX -->
        </div>
    </section>
    
    <!-- Progress Ring (HTMX-powered, updates on expense-added event) -->
    <div id="progress-ring" class="card"
         hx-get="/partials/progress" 
         hx-trigger="load, expense-added from:body"
         hx-swap="innerHTML">
        <!-- Progress ring content populated by HTMX -->
    </div>
    
    <!-- Expense Chart (HTMX-powered, updates on expense-added event) -->
    <div id="expense-chart" class="card"
         hx-get="/partials/chart" 
         hx-trigger="load, expense-added from:body"
         hx-swap="innerHTML">
        <!-- Chart will be rendered here by HTMX -->
    </div>

    <!-- Welcome Banner -->
    <section class="card welcome-banner">
        <div class="alert alert-info">
            <div class="d-flex align-items-start gap-3">
                <div class="banner-icon" style="font-size: 2rem;">🤖</div>
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-2">Hi! I'm your AI expense assistant. You can:</h5>
                    <ul class="mb-2" style="font-size: 0.875rem; line-height: 1.6;">
                        <li>📝 Say "I spent 500 taka on lunch" to log expenses</li>
                        <li>📊 Ask "Show my spending summary"</li>
                        <li>💡 Get insights: "How's my spending this month?"</li>
                        <li>🎯 Ask for financial advice and tips</li>
                    </ul>
                    <p class="mb-0" style="font-size: 0.875rem;">Just type naturally - I'll understand! 😊</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Active Chat Interface -->
    <section class="card chat-card" aria-labelledby="chat-title">
        <h2 id="chat-title" class="card-title">💬 Chat with finbrain AI</h2>
        
        <!-- Chat Messages -->
        <div id="chat-error" class="alert alert-danger hidden"></div>
        <div id="chat-messages" class="chat-messages">
            <!-- Messages will appear here -->
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-container">
            <form id="chat-form" class="chat-form">
                <div class="chat-input-group">
                    <textarea id="chat-input" name="message" class="chat-input" 
                              placeholder="Type your message... (e.g., 'I spent 200 taka on groceries')"
                              rows="2" maxlength="500"></textarea>
                    <button type="submit" class="btn btn-primary chat-send-btn" id="chat-send">
                        <span class="btn-text">Send</span>
                        <span id="chat-spinner" class="btn-loading hidden">⏳</span>
                    </button>
                </div>
                <div class="chat-suggestions">
                    <button type="button" class="suggestion-btn" onclick="fillChatInput('Show my expenses this week')">
                        📊 Weekly summary
                    </button>
                    <button type="button" class="suggestion-btn" onclick="fillChatInput('I spent 300 taka on dinner')">
                        💰 Log expense
                    </button>
                    <button type="button" class="suggestion-btn" onclick="fillChatInput('Give me some budgeting tips')">
                        💡 Get tips
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Recent Expenses -->
        <div id="recent-expenses-list" class="recent-expenses-list" 
             hx-get="/partials/entries" 
             hx-trigger="load, expense-added from:body" 
             hx-swap="innerHTML">
            <!-- Entries will load here -->
        </div>
    </section>

    <script>
    // HTML escape utility
    function escapeHtml(s) {
        return s.replace(/[&<>"']/g, m => ({
            '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[m]));
    }
    
    // Chat suggestion functionality
    function fillChatInput(suggestion) {
        const input = document.getElementById('chat-input');
        if (input) {
            input.value = suggestion;
            input.focus();
        }
    }
    
    // Auto-resize textarea (with safety check)
    document.addEventListener('DOMContentLoaded', () => {
        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
        }
    });

    // Smart banners now handled by HTMX (/partials/banner endpoint)
    // Progress ring now handled by HTMX (/partials/progress endpoint)
    // Chart now handled by HTMX (/partials/chart endpoint)
    </script>
</div>


<!-- keep just this; remove older script tags -->
<script src="/static/js/chat-handler.js?v=20250930_2" defer></script>
{% endblock %}