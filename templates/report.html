{% extends "base.html" %}

{% block title %}Report - FinBrain{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Hero Section -->
    <header class="hero-section">
        <h1 class="hero-title">Your Money Story</h1>
        <p class="hero-subtitle">AI-powered insights and spending analysis</p>
    </header>

    <!-- Summary Cards -->
    <section class="summary-grid" aria-labelledby="summary-title">
        <h2 id="summary-title" class="sr-only">Spending Summary</h2>
        
        <div class="card summary-card">
            <div class="summary-header">
                <h3 class="summary-title">Today</h3>
                <div class="summary-icon">📅</div>
            </div>
            <div class="summary-value" id="today-total">
                <div class="loading-spinner">Loading...</div>
            </div>
            <div class="summary-change" id="today-change">
                <div class="loading-spinner">Loading...</div>
            </div>
        </div>

        <div class="card summary-card">
            <div class="summary-header">
                <h3 class="summary-title">This Week</h3>
                <div class="summary-icon">📊</div>
            </div>
            <div class="summary-value" id="week-total">
                <div class="loading-spinner">Loading...</div>
            </div>
            <div class="summary-change" id="week-change">
                <div class="loading-spinner">Loading...</div>
            </div>
        </div>

        <div class="card summary-card">
            <div class="summary-header">
                <h3 class="summary-title">This Month</h3>
                <div class="summary-icon">📈</div>
            </div>
            <div class="summary-value" id="month-total">
                <div class="loading-spinner">Loading...</div>
            </div>
            <div class="summary-change" id="month-change">
                <div class="loading-spinner">Loading...</div>
            </div>
        </div>
    </section>

    <!-- Top Categories -->
    <section class="card categories-section" aria-labelledby="categories-title">
        <h2 id="categories-title" class="card-title">Top Categories This Month</h2>
        
        <div class="categories-list" id="categories-list">
            <div class="loading-spinner">Loading categories...</div>
        </div>
    </section>

    <!-- AI Insights -->
    <section class="card insights-section" aria-labelledby="insights-title">
        <h2 id="insights-title" class="card-title">AI Insights</h2>
        
        <div class="insights-list" id="insights-list">
            <div class="loading-spinner">Generating insights...</div>
        </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions" aria-labelledby="actions-title">
        <h2 id="actions-title" class="section-title">Quick Actions</h2>
        
        <div class="actions-grid">
            <button class="action-card" onclick="window.location.href='/chat'">
                <div class="action-icon">➕</div>
                <span class="action-label">Add Expense</span>
            </button>

            <button class="action-card" onclick="showExportOptions()">
                <div class="action-icon">📤</div>
                <span class="action-label">Export Data</span>
            </button>

            <button class="action-card" onclick="showBudgetSettings()">
                <div class="action-icon">🎯</div>
                <span class="action-label">Set Budget</span>
            </button>

            <button class="action-card" onclick="showToast('Coming soon! AI will analyze your spending patterns.', 'info')">
                <div class="action-icon">🤖</div>
                <span class="action-label">AI Analysis</span>
            </button>
        </div>
    </section>
</div>

<script>
// Global variables for data storage
let reportData = {
    today: null,
    week: null,
    month: null,
    expenses: [],
    categories: {}
};

// API Helper Functions
async function apiCall(endpoint, data = {}) {
    try {
        console.log(`[Report] Making API call to ${endpoint} with data:`, data);
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include', // Include session cookies
            body: JSON.stringify(data)
        });

        console.log(`[Report] API response status: ${response.status}`);

        if (!response.ok) {
            if (response.status === 401) {
                console.warn('[Report] User not authenticated, redirecting to login');
                // User not authenticated, redirect to login
                window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
                return null;
            }
            
            const errorText = await response.text();
            console.error(`[Report] API error ${response.status}:`, errorText);
            throw new Error(`API call failed: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        console.log(`[Report] API response from ${endpoint}:`, result);
        
        // Check if response has expected structure
        if (result.success && result.data) {
            console.log(`[Report] Extracted data from ${endpoint}:`, result.data);
            return result.data;
        } else if (result.data) {
            console.log(`[Report] Using direct data from ${endpoint}:`, result.data);
            return result.data;
        } else {
            console.log(`[Report] Using full result from ${endpoint}:`, result);
            return result;
        }
    } catch (error) {
        console.error(`[Report] API call to ${endpoint} failed:`, error);
        throw error;
    }
}

// Format currency amount
function formatCurrency(amountMinor) {
    if (amountMinor === null || amountMinor === undefined) return '৳0';
    const amount = amountMinor / 100;
    return `৳${amount.toLocaleString('en-BD', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`;
}

// Get category icon
function getCategoryIcon(category) {
    const icons = {
        'food': '🍽️',
        'transport': '🚗',
        'shopping': '🛍️',
        'bills': '💡',
        'uncategorized': '📦',
        'other': '📦'
    };
    return icons[category.toLowerCase()] || '📦';
}

// Format category name
function formatCategoryName(category) {
    const names = {
        'food': 'Food & Dining',
        'transport': 'Transport',
        'shopping': 'Shopping',
        'bills': 'Bills & Utilities',
        'uncategorized': 'Other',
        'other': 'Other'
    };
    return names[category.toLowerCase()] || category.charAt(0).toUpperCase() + category.slice(1);
}

// Load Summary Data
async function loadSummaryData() {
    try {
        console.log('[Report] Loading summary data...');
        
        // Show loading state
        ['today', 'week', 'month'].forEach(period => {
            const totalElement = document.getElementById(`${period}-total`);
            const changeElement = document.getElementById(`${period}-change`);
            if (totalElement) totalElement.innerHTML = '<div class="loading-spinner">Loading...</div>';
            if (changeElement) changeElement.innerHTML = '<div class="loading-spinner">Loading...</div>';
        });
        
        // Fetch totals for different periods
        console.log('[Report] Fetching totals from API...');
        const [todayData, weekData, monthData] = await Promise.all([
            apiCall('/api/backend/get_totals', { period: 'day' }),
            apiCall('/api/backend/get_totals', { period: 'week' }),
            apiCall('/api/backend/get_totals', { period: 'month' })
        ]);

        console.log('[Report] Received API responses:', {
            today: todayData,
            week: weekData, 
            month: monthData
        });

        reportData.today = todayData;
        reportData.week = weekData;
        reportData.month = monthData;

        // Update summary cards
        updateSummaryCard('today', todayData);
        updateSummaryCard('week', weekData);
        updateSummaryCard('month', monthData);

        console.log('[Report] Summary data loaded successfully');
    } catch (error) {
        console.error('[Report] Failed to load summary data:', error);
        
        // Try to show a user-friendly error message
        const errorMessage = error.message || 'Unknown error occurred';
        if (typeof showError === 'function') {
            showError(`Failed to load spending summary: ${errorMessage}. Please refresh the page.`);
        } else {
            console.error('[Report] showError function not available');
        }
        
        // Show error state in summary cards
        ['today', 'week', 'month'].forEach(period => {
            const totalElement = document.getElementById(`${period}-total`);
            const changeElement = document.getElementById(`${period}-change`);
            if (totalElement) totalElement.innerHTML = '<span class="error-text">Error</span>';
            if (changeElement) changeElement.innerHTML = '<span class="error-text">Unable to load</span>';
        });
    }
}

// Update Summary Card
function updateSummaryCard(period, data) {
    console.log(`[Report] Updating summary card for ${period} with data:`, data);
    
    const totalElement = document.getElementById(`${period}-total`);
    const changeElement = document.getElementById(`${period}-change`);
    
    if (!totalElement || !changeElement) {
        console.error(`[Report] DOM elements not found for period: ${period}`);
        return;
    }
    
    if (!data) {
        console.warn(`[Report] No data provided for ${period}`);
        totalElement.innerHTML = '<span class="error-text">No data</span>';
        changeElement.innerHTML = '<span class="error-text">Unable to load</span>';
        return;
    }

    // Update total amount
    const totalMinor = data.total_minor || 0;
    const formattedAmount = formatCurrency(totalMinor);
    console.log(`[Report] Formatted amount for ${period}: ${formattedAmount} (from ${totalMinor})`);
    totalElement.textContent = formattedAmount;

    // Update change/status
    const expenseCount = data.expenses_count || 0;
    console.log(`[Report] Expense count for ${period}: ${expenseCount}`);
    
    if (expenseCount === 0) {
        changeElement.innerHTML = '<span class="summary-change neutral">No expenses yet</span>';
        changeElement.className = 'summary-change neutral';
    } else {
        changeElement.innerHTML = `<span class="summary-change neutral">${expenseCount} expense${expenseCount !== 1 ? 's' : ''}</span>`;
        changeElement.className = 'summary-change neutral';
    }
    
    console.log(`[Report] Successfully updated ${period} card`);
}

// Load Categories Data
async function loadCategoriesData() {
    try {
        console.log('[Report] Loading categories data...');
        
        // Get recent expenses to calculate category totals
        const expensesData = await apiCall('/api/backend/get_recent_expenses', { limit: 100 });
        
        if (!expensesData || !Array.isArray(expensesData)) {
            throw new Error('Invalid expenses data received');
        }

        reportData.expenses = expensesData;

        // Calculate category totals from recent expenses
        const categoryTotals = {};
        let totalSpent = 0;

        expensesData.forEach(expense => {
            const category = expense.category || 'other';
            const amount = expense.amount_minor || expense.amount * 100 || 0;
            
            if (!categoryTotals[category]) {
                categoryTotals[category] = 0;
            }
            categoryTotals[category] += amount;
            totalSpent += amount;
        });

        reportData.categories = categoryTotals;

        // Update categories display
        updateCategoriesDisplay(categoryTotals, totalSpent);

        console.log('[Report] Categories data loaded successfully');
    } catch (error) {
        console.error('[Report] Failed to load categories data:', error);
        showError('Failed to load category breakdown. Please refresh the page.');
        
        document.getElementById('categories-list').innerHTML = '<div class="error-text">Unable to load categories</div>';
    }
}

// Update Categories Display
function updateCategoriesDisplay(categoryTotals, totalSpent) {
    const categoriesList = document.getElementById('categories-list');
    
    if (totalSpent === 0) {
        categoriesList.innerHTML = '<div class="no-data">No expenses recorded yet. Start by adding some expenses!</div>';
        return;
    }

    // Sort categories by amount (descending)
    const sortedCategories = Object.entries(categoryTotals)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5); // Show top 5 categories

    const categoriesHTML = sortedCategories.map(([category, amountMinor]) => {
        const percentage = Math.round((amountMinor / totalSpent) * 100);
        const formattedAmount = formatCurrency(amountMinor);
        const icon = getCategoryIcon(category);
        const name = formatCategoryName(category);

        return `
            <div class="category-item">
                <div class="category-info">
                    <span class="category-icon">${icon}</span>
                    <span class="category-name">${name}</span>
                </div>
                <div class="category-amount">${formattedAmount}</div>
                <div class="category-bar">
                    <div class="category-progress" style="width: ${percentage}%"></div>
                </div>
            </div>
        `;
    }).join('');

    categoriesList.innerHTML = categoriesHTML;
}

// Load Insights Data
async function loadInsightsData() {
    try {
        console.log('[Report] Loading insights data...');
        
        // Generate insights based on the data we have
        const insights = generateInsights();
        updateInsightsDisplay(insights);

        console.log('[Report] Insights data loaded successfully');
    } catch (error) {
        console.error('[Report] Failed to load insights data:', error);
        document.getElementById('insights-list').innerHTML = '<div class="error-text">Unable to generate insights</div>';
    }
}

// Generate Insights
function generateInsights() {
    const insights = [];
    const { today, week, month, expenses, categories } = reportData;

    // Insight 1: Spending summary
    if (month && month.total_minor > 0) {
        const monthlyAmount = formatCurrency(month.total_minor);
        const expenseCount = month.expenses_count || 0;
        insights.push({
            type: 'info',
            icon: '📊',
            title: 'Monthly Summary',
            text: `You've spent ${monthlyAmount} across ${expenseCount} expense${expenseCount !== 1 ? 's' : ''} this month.`
        });
    }

    // Insight 2: Top category analysis
    if (Object.keys(categories).length > 0) {
        const topCategory = Object.entries(categories)
            .sort(([,a], [,b]) => b - a)[0];
        
        if (topCategory) {
            const [categoryName, amount] = topCategory;
            const formattedAmount = formatCurrency(amount);
            const categoryDisplayName = formatCategoryName(categoryName);
            
            insights.push({
                type: 'tip',
                icon: '💡',
                title: 'Top Spending Category',
                text: `${categoryDisplayName} is your biggest expense at ${formattedAmount}. Consider reviewing these purchases.`
            });
        }
    }

    // Insight 3: Recent activity
    if (week && today) {
        const weeklyAvg = week.total_minor / 7;
        const todayAmount = today.total_minor || 0;
        
        if (todayAmount > weeklyAvg * 1.5) {
            insights.push({
                type: 'warning',
                icon: '⚠️',
                title: 'High Spending Day',
                text: `Today's spending is above your weekly average. Consider reviewing your purchases.`
            });
        } else if (todayAmount === 0 && week.total_minor > 0) {
            insights.push({
                type: 'success',
                icon: '🎯',
                title: 'No Spending Today',
                text: `Great job! You haven't spent anything today. Keep up the mindful spending!`
            });
        }
    }

    // Default insight if no data
    if (insights.length === 0) {
        insights.push({
            type: 'info',
            icon: '🚀',
            title: 'Get Started',
            text: 'Start tracking your expenses to see personalized insights and spending patterns!'
        });
    }

    return insights.slice(0, 3); // Show max 3 insights
}

// Update Insights Display
function updateInsightsDisplay(insights) {
    const insightsList = document.getElementById('insights-list');
    
    const insightsHTML = insights.map(insight => `
        <div class="insight-item insight-${insight.type}">
            <div class="insight-icon">${insight.icon}</div>
            <div class="insight-content">
                <h3 class="insight-title">${insight.title}</h3>
                <p class="insight-text">${insight.text}</p>
            </div>
        </div>
    `).join('');

    insightsList.innerHTML = insightsHTML;
}

// Error Handling
function showError(message) {
    showToast(message, 'error');
}

// Toast helper function (same as chat.html)
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-message">${message}</span>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
        </div>
    `;
    
    const toastContainer = document.getElementById('toast-container');
    if (toastContainer) {
        toastContainer.appendChild(toast);
    } else {
        // Create toast container if it doesn't exist
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000;';
        document.body.appendChild(container);
        container.appendChild(toast);
    }
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Quick Actions
function showExportOptions() {
    showToast('Export feature coming soon! You\'ll be able to download your data as CSV or PDF.', 'info');
}

function showBudgetSettings() {
    showToast('Budget management coming soon! Set spending limits for each category.', 'info');
}

// Initialize Report
async function initializeReport() {
    console.log('[Report] Initializing report page...');
    
    try {
        // Load all data in parallel
        await Promise.all([
            loadSummaryData(),
            loadCategoriesData()
        ]);
        
        // Load insights after other data is ready
        await loadInsightsData();
        
        console.log('[Report] Report initialization completed successfully');
    } catch (error) {
        console.error('[Report] Failed to initialize report:', error);
        showError('Failed to load report data. Please refresh the page.');
    }
}

// Start loading data when page loads
document.addEventListener('DOMContentLoaded', initializeReport);
</script>
{% endblock %}