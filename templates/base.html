<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0066ff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="finbrain">
    
    <title>{% block title %}finbrain - AI Financial Assistant{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" href="/static/favicon.ico">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.webmanifest">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/static/icons/icon-512.png">
    
    <!-- Bootstrap 5 & Font Awesome for Profile V2 Google/Stripe design -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <!-- Custom CSS (loaded after Bootstrap so it can override) -->
    <link rel="stylesheet" href="/static/css/app.css">
    
    <!-- Profile V2 specific styles (cache-busted) -->
    {% if request.endpoint == 'pwa_ui.profile' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile_v2.css') }}?v=20250929">
    {% endif %}
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
    
    <!-- PWA Script -->
    <script src="/static/js/pwa.js" defer></script>
    
    <!-- Profile V2 JavaScript (cache-busted) -->
    {% if request.endpoint == 'pwa_ui.profile' %}
    <script src="{{ url_for('static', filename='js/profile_v2.js') }}?v=20250929" defer></script>
    {% endif %}
</head>
<body>
    <!-- Offline Banner -->
    <div id="offline-banner" class="offline-banner hidden" role="alert" aria-live="polite">
        <div class="offline-banner-content">
            <span class="offline-icon">ðŸ“¶</span>
            <span>You're offline. Some features may be limited.</span>
        </div>
    </div>

    <!-- Install Banner -->
    <div id="install-banner" class="install-banner hidden" role="banner">
        <div class="install-banner-content">
            <span class="install-icon">ðŸ“±</span>
            <span>Install finbrain for quick access</span>
            <button id="install-button" class="btn btn-primary btn-sm">Install</button>
            <button id="install-dismiss" class="btn btn-neutral btn-sm">Not now</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="app-container">
        {% block content %}{% endblock %}
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
        <a href="/chat" class="nav-item {% if request.endpoint == 'pwa_ui.chat' %}active{% endif %}" 
           aria-label="Chat and expense tracking">
            <div class="nav-icon">ðŸ’¬</div>
            <span class="nav-label">Chat</span>
        </a>
        
        <a href="/report" class="nav-item {% if request.endpoint == 'pwa_ui.report' %}active{% endif %}"
           aria-label="Financial reports and insights">
            <div class="nav-icon">ðŸ“Š</div>
            <span class="nav-label">Report</span>
        </a>
        
        <a href="/profile" class="nav-item {% if request.endpoint == 'pwa_ui.profile' %}active{% endif %}"
           aria-label="User profile and settings">
            <div class="nav-icon">ðŸ‘¤</div>
            <span class="nav-label">Profile</span>
        </a>
        
        <a href="/challenge" class="nav-item {% if request.endpoint == 'pwa_ui.challenge' %}active{% endif %}"
           aria-label="Financial challenges and goals">
            <div class="nav-icon">ðŸŽ¯</div>
            <span class="nav-label">Challenge</span>
        </a>
    </nav>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true">
        <!-- Toasts will be dynamically inserted here -->
    </div>
    
    <!-- Auth State Manager -->
    <script>
    (() => {
        'use strict';
        
        // Auth check with timeout protection
        async function checkAuthState() {
            try {
                // Create AbortController for 10s timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch('/api/auth/me', {
                    method: 'GET',
                    credentials: 'include', // Include session cookies
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const userData = await response.json();
                    
                    // Set global auth state
                    window.__USER_ID__ = userData.user_id;
                    window.__USER_EMAIL__ = userData.email;
                    window.__USER_NAME__ = userData.name;
                    
                    // Add signed-in class to body
                    document.body.classList.add('signed-in');
                    document.body.classList.remove('signed-out');
                    
                    console.log('User authenticated:', userData.email);
                } else {
                    // Not authenticated
                    window.__USER_ID__ = null;
                    window.__USER_EMAIL__ = null;
                    window.__USER_NAME__ = null;
                    
                    // Add signed-out class to body
                    document.body.classList.add('signed-out');
                    document.body.classList.remove('signed-in');
                    
                    console.log('User not authenticated');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Auth check timeout after 10s');
                } else {
                    console.warn('Auth check failed:', error.message);
                }
                
                // Default to signed-out on error
                window.__USER_ID__ = null;
                window.__USER_EMAIL__ = null;
                window.__USER_NAME__ = null;
                document.body.classList.add('signed-out');
                document.body.classList.remove('signed-in');
            }
        }
        
        // Run auth check on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkAuthState);
        } else {
            checkAuthState();
        }
        
        // Make checkAuthState available globally for manual refresh
        window.refreshAuthState = checkAuthState;
    })();
    </script>
    
</body>
</html>